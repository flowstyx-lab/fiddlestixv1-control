<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FiddleStix V1 Control</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Chart.js for graphs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg: #050712;
      --panel: rgba(19, 25, 45, 0.95);
      --accent: #ff5e99;
      --accent-soft: rgba(255, 94, 153, 0.25);
      --text: #f3f3ff;
      --muted: #9ca3c7;
      --border: rgba(148, 163, 184, 0.3);
      --radius: 18px;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background: radial-gradient(circle at top, #1f2937 0, #020617 50%, #000 100%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
    }

    .app {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.3fr);
      gap: 20px;
      padding: 20px;
      width: 100%;
      max-width: 1200px;
    }

    @media (max-width: 900px) {
      .app {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: var(--panel);
      border-radius: var(--radius);
      padding: 16px 18px 20px;
      border: 1px solid var(--border);
      box-shadow: 0 24px 40px rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(12px);
    }

    h1 {
      font-size: 1.6rem;
      margin: 0 0 6px;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--accent);
    }

    .subtitle {
      font-size: 0.85rem;
      color: var(--muted);
      margin-bottom: 14px;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      margin-bottom: 10px;
    }

    .row.space-between {
      justify-content: space-between;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 7px 16px;
      font-size: 0.9rem;
      background: rgba(15, 23, 42, 0.85);
      color: var(--text);
      cursor: pointer;
      border: 1px solid transparent;
      transition: all 0.15s ease-out;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    button.primary {
      background: linear-gradient(135deg, #f97316, #ef4444, #ec4899);
      border-color: rgba(248, 113, 113, 0.7);
      color: #fff;
      font-weight: 600;
      box-shadow: 0 10px 25px rgba(248, 113, 113, 0.4);
    }

    button:disabled {
      opacity: 0.5;
      cursor: default;
      box-shadow: none;
    }

    button:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.9);
      border-color: var(--accent-soft);
    }

    button.toggled {
      border-color: var(--accent);
      background: radial-gradient(circle at top, var(--accent-soft), rgba(15, 23, 42, 0.95));
    }

    .badge {
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.5);
      color: var(--muted);
    }

    .status-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
      margin-top: 10px;
    }

    .status-item {
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.9), #020617);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 0.78rem;
      border: 1px solid rgba(148, 163, 184, 0.35);
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: var(--muted);
    }

    .status-item span.value {
      color: var(--text);
      font-weight: 500;
    }

    .slider-group {
      margin: 10px 0;
    }

    .slider-label {
      display: flex;
      justify-content: space-between;
      font-size: 0.8rem;
      color: var(--muted);
      margin-bottom: 4px;
    }

    input[type="range"] {
      width: 100%;
      accent-color: var(--accent);
    }

    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 4px;
    }

    .chip {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      border: 2px solid transparent;
      cursor: pointer;
      box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.9);
      transition: all 0.15s ease-out;
    }

    .chip.active {
      box-shadow: 0 0 0 2px #e5e7eb, 0 0 0 4px rgba(56, 189, 248, 0.6);
      transform: translateY(-1px);
    }

    .chip.white { background: radial-gradient(circle at top, #f9fafb, #e5e7eb); }
    .chip.red   { background: radial-gradient(circle at top, #fee2e2, #ef4444); }
    .chip.orange{ background: radial-gradient(circle at top, #ffedd5, #f97316); }
    .chip.yellow{ background: radial-gradient(circle at top, #fef9c3, #eab308); }
    .chip.green { background: radial-gradient(circle at top, #dcfce7, #22c55e); }
    .chip.blue  { background: radial-gradient(circle at top, #dbeafe, #3b82f6); }
    .chip.indigo{ background: radial-gradient(circle at top, #e0e7ff, #6366f1); }
    .chip.violet{ background: radial-gradient(circle at top, #f5e1ff, #a855f7); }
    .chip.black { background: radial-gradient(circle at top, #4b5563, #020617); }

    canvas {
      background: radial-gradient(circle at top, rgba(31, 41, 55, 0.9), #020617);
      border-radius: 14px;
      border: 1px solid rgba(51, 65, 85, 0.9);
    }

    .graph-title {
      font-size: 0.85rem;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .legend-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      margin-right: 4px;
    }

    .legend {
      display: flex;
      gap: 10px;
      font-size: 0.75rem;
      margin-top: 4px;
      color: var(--muted);
    }

    .small {
      font-size: 0.78rem;
      color: var(--muted);
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- LEFT: Controls -->
    <div class="card">
      <h1>FiddleStix V1</h1>
      <div class="subtitle">Real-time control & telemetry over Web Bluetooth</div>

      <div class="row space-between">
        <div class="row">
          <button id="connectBtn" class="primary">Connect</button>
          <button id="disconnectBtn" disabled>Disconnect</button>
        </div>
        <div class="badge" id="connStatus">Disconnected</div>
      </div>

      <div class="row">
        <button id="onBtn">On</button>
        <button id="offBtn">Off</button>
        <button id="discoBtn">Disco</button>
        <button id="sleepToggleBtn">Sleep</button>
      </div>

      <div class="row">
        <button id="nextPatternBtn">Next Pattern</button>
        <button id="favBtn">Favorite → White#1</button>
      </div>

      <div class="status-grid">
        <div class="status-item">
          <span>List</span>
          <span class="value" id="listStatus">0</span>
        </div>
        <div class="status-item">
          <span>Pattern</span>
          <span class="value" id="patternStatus">0</span>
        </div>
        <div class="status-item">
          <span>Mode</span>
          <span class="value" id="modeStatus">OFF</span>
        </div>
        <div class="status-item">
          <span>B Level</span>
          <span class="value" id="bStatus">4</span>
        </div>
        <div class="status-item">
          <span>T (s)</span>
          <span class="value" id="tStatus">12</span>
        </div>
        <div class="status-item">
          <span>Battery</span>
          <span class="value" id="battStatus">--%</span>
        </div>
      </div>

      <!-- Sliders -->
      <div class="slider-group">
        <div class="slider-label">
          <span>Brightness (B 1–7)</span>
          <span id="bSliderVal">4</span>
        </div>
        <input id="bSlider" type="range" min="1" max="7" step="1" value="4" />
      </div>

      <div class="slider-group">
        <div class="slider-label">
          <span>Meta / Disco dwell time T (s)</span>
          <span id="tSliderVal">12</span>
        </div>
        <input id="tSlider" type="range" min="1" max="120" step="1" value="12" />
      </div>

      <div class="slider-group">
        <div class="slider-label">
          <span>Pattern index (0–100)</span>
          <span id="patternSliderVal">0</span>
        </div>
        <input id="patternSlider" type="range" min="0" max="100" step="1" value="0" />
        <div class="small">0 = meta pattern (auto-cycles 1–100 by T seconds)</div>
      </div>

      <!-- List selection chips -->
      <div style="margin-top: 12px;">
        <div class="slider-label">
          <span>List (W-R-O-Y-G-B-I-V-Bl)</span>
          <span id="listName">White (0)</span>
        </div>
        <div class="chip-row">
          <div class="chip white active"  data-list="0" title="White"></div>
          <div class="chip red"           data-list="1" title="Red"></div>
          <div class="chip orange"        data-list="2" title="Orange"></div>
          <div class="chip yellow"        data-list="3" title="Yellow"></div>
          <div class="chip green"         data-list="4" title="Green"></div>
          <div class="chip blue"          data-list="5" title="Blue"></div>
          <div class="chip indigo"        data-list="6" title="Indigo"></div>
          <div class="chip violet"        data-list="7" title="Violet"></div>
          <div class="chip black"         data-list="8" title="Black / Reactive"></div>
        </div>
      </div>
    </div>

    <!-- RIGHT: Graphs -->
    <div class="card">
      <div class="graph-title">IMU Acceleration (X,Y,Z in g)</div>
      <canvas id="imuChart" height="150"></canvas>
      <div class="legend">
        <div><span class="legend-dot" style="background:#22c55e;"></span>X</div>
        <div><span class="legend-dot" style="background:#3b82f6;"></span>Y</div>
        <div><span class="legend-dot" style="background:#eab308;"></span>Z</div>
      </div>

      <div style="height:14px;"></div>

      <div class="graph-title">Mic Level (normalized 0–1)</div>
      <canvas id="micChart" height="120"></canvas>
      <div class="legend">
        <div><span class="legend-dot" style="background:#fb7185;"></span>Mic</div>
        <div class="small">Showing last 30 seconds for both IMU and Mic.</div>
      </div>
    </div>
  </div>

  <script>
    // Nordic UART (BLEUart) UUIDs
    const NUS_SERVICE_UUID       = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
    const NUS_RX_CHAR_UUID       = '6e400002-b5a3-f393-e0a9-e50e24dcca9e'; // write
    const NUS_TX_CHAR_UUID       = '6e400003-b5a3-f393-e0a9-e50e24dcca9e'; // notify

    let device = null;
    let server = null;
    let nusService = null;
    let rxChar = null;
    let txChar = null;
    let connected = false;
    let rxBuffer = '';

    // DOM
    const connectBtn        = document.getElementById('connectBtn');
    const disconnectBtn     = document.getElementById('disconnectBtn');
    const connStatus        = document.getElementById('connStatus');
    const onBtn             = document.getElementById('onBtn');
    const offBtn            = document.getElementById('offBtn');
    const discoBtn          = document.getElementById('discoBtn');
    const sleepToggleBtn    = document.getElementById('sleepToggleBtn');
    const nextPatternBtn    = document.getElementById('nextPatternBtn');
    const favBtn            = document.getElementById('favBtn');
    const listStatus        = document.getElementById('listStatus');
    const patternStatus     = document.getElementById('patternStatus');
    const modeStatus        = document.getElementById('modeStatus');
    const bStatus           = document.getElementById('bStatus');
    const tStatus           = document.getElementById('tStatus');
    const battStatus        = document.getElementById('battStatus');
    const bSlider           = document.getElementById('bSlider');
    const bSliderVal        = document.getElementById('bSliderVal');
    const tSlider           = document.getElementById('tSlider');
    const tSliderVal        = document.getElementById('tSliderVal');
    const patternSlider     = document.getElementById('patternSlider');
    const patternSliderVal  = document.getElementById('patternSliderVal');
    const listName          = document.getElementById('listName');

    const listChips = Array.from(document.querySelectorAll('.chip'));

    // Chart.js setup
    const imuCtx = document.getElementById('imuChart').getContext('2d');
    const micCtx = document.getElementById('micChart').getContext('2d');

    const MAX_POINTS = 300; // ~ last 30s at 10Hz

    const imuData = {
      labels: [],
      datasets: [
        {
          label: 'X',
          data: [],
          borderColor: '#22c55e',
          borderWidth: 1.2,
          pointRadius: 0,
          tension: 0.25
        },
        {
          label: 'Y',
          data: [],
          borderColor: '#3b82f6',
          borderWidth: 1.2,
          pointRadius: 0,
          tension: 0.25
        },
        {
          label: 'Z',
          data: [],
          borderColor: '#eab308',
          borderWidth: 1.2,
          pointRadius: 0,
          tension: 0.25
        }
      ]
    };

    const micData = {
      labels: [],
      datasets: [
        {
          label: 'Mic',
          data: [],
          borderColor: '#fb7185',
          borderWidth: 1.3,
          pointRadius: 0,
          tension: 0.25,
          fill: true,
          backgroundColor: 'rgba(248, 113, 113, 0.15)'
        }
      ]
    };

    const commonOptions = {
      animation: false,
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: {
          ticks: {
            display: false
          },
          grid: { display: false }
        },
        y: {
          grid: {
            color: 'rgba(148, 163, 184, 0.25)'
          },
          ticks: {
            font: { size: 9 },
            color: '#9ca3c7'
          }
        }
      },
      plugins: {
        legend: { display: false }
      }
    };

    const imuChart = new Chart(imuCtx, {
      type: 'line',
      data: imuData,
      options: {
        ...commonOptions,
        scales: {
          ...commonOptions.scales,
          y: {
            ...commonOptions.scales.y,
            suggestedMin: -3,
            suggestedMax: 3
          }
        }
      }
    });

    const micChart = new Chart(micCtx, {
      type: 'line',
      data: micData,
      options: {
        ...commonOptions,
        scales: {
          ...commonOptions.scales,
          y: {
            ...commonOptions.scales.y,
            suggestedMin: 0,
            suggestedMax: 1
          }
        }
      }
    });

    function addDataPoints(ax, ay, az, mic) {
      const now = new Date();
      const label = now.toLocaleTimeString();

      imuData.labels.push(label);
      imuData.datasets[0].data.push(ax);
      imuData.datasets[1].data.push(ay);
      imuData.datasets[2].data.push(az);

      micData.labels.push(label);
      micData.datasets[0].data.push(mic);

      if (imuData.labels.length > MAX_POINTS) {
        imuData.labels.shift();
        imuData.datasets.forEach(d => d.data.shift());
      }

      if (micData.labels.length > MAX_POINTS) {
        micData.labels.shift();
        micData.datasets[0].data.shift();
      }

      imuChart.update();
      micChart.update();
    }

    function setConnectedUi(state) {
      connected = state;
      connectBtn.disabled = state;
      disconnectBtn.disabled = !state;
      onBtn.disabled = !state;
      offBtn.disabled = !state;
      discoBtn.disabled = !state;
      sleepToggleBtn.disabled = !state;
      nextPatternBtn.disabled = !state;
      favBtn.disabled = !state;
      bSlider.disabled = !state;
      tSlider.disabled = !state;
      patternSlider.disabled = !state;
      listChips.forEach(chip => chip.style.pointerEvents = state ? 'auto' : 'none');

      connStatus.textContent = state ? 'Connected' : 'Disconnected';
      connStatus.style.color = state ? '#4ade80' : '#9ca3c7';
    }

    async function connect() {
      try {
        device = await navigator.bluetooth.requestDevice({
          filters: [{ namePrefix: 'FiddleStIXV1' }],
          optionalServices: [NUS_SERVICE_UUID]
        });

        device.addEventListener('gattserverdisconnected', onDisconnected);

        server = await device.gatt.connect();
        nusService = await server.getPrimaryService(NUS_SERVICE_UUID);
        rxChar = await nusService.getCharacteristic(NUS_RX_CHAR_UUID);
        txChar = await nusService.getCharacteristic(NUS_TX_CHAR_UUID);

        await txChar.startNotifications();
        txChar.addEventListener('characteristicvaluechanged', handleNotifications);

        setConnectedUi(true);
      } catch (error) {
        console.error('Connection failed:', error);
        alert('Failed to connect: ' + error);
      }
    }

    async function disconnect() {
      try {
        if (device && device.gatt.connected) {
          await device.gatt.disconnect();
        }
      } catch (e) {
        console.warn('Disconnect error:', e);
      } finally {
        setConnectedUi(false);
      }
    }

    function onDisconnected() {
      setConnectedUi(false);
    }

    function handleNotifications(event) {
      const value = event.target.value;
      const text = new TextDecoder().decode(value);
      rxBuffer += text;

      let lines = rxBuffer.split('\n');
      rxBuffer = lines.pop(); // leftover partial

      for (const rawLine of lines) {
        const line = rawLine.trim();
        if (!line) continue;
        if (line.startsWith('DATA,')) {
          const parts = line.split(',');
          if (parts.length >= 12) {
            const ax = parseFloat(parts[1]);
            const ay = parseFloat(parts[2]);
            const az = parseFloat(parts[3]);
            const mic = parseFloat(parts[4]);
            const batt = parseInt(parts[5], 10);
            const list = parseInt(parts[6], 10);
            const pat  = parseInt(parts[7], 10);
            const B    = parseInt(parts[8], 10);
            const T    = parseInt(parts[9], 10);
            const sleep = parseInt(parts[10], 10);
            const mode  = parseInt(parts[11], 10);

            addDataPoints(ax, ay, az, mic);
            updateStatusFromTelemetry(list, pat, B, T, batt, sleep, mode);
          }
        }
      }
    }

    function sendCommand(cmd) {
      if (!connected || !rxChar) return;
      const data = new TextEncoder().encode(cmd + '\n');
      rxChar.writeValue(data).catch(err => console.error('Write error:', err));
    }

    function updateStatusFromTelemetry(list, pat, B, T, batt, sleep, mode) {
      listStatus.textContent = list;
      patternStatus.textContent = pat;
      bStatus.textContent = B;
      tStatus.textContent = T;
      battStatus.textContent = `${batt}%`;

      // Keep sliders visually in sync (but don't spam commands)
      if (!bSlider._locked) {
        bSlider.value = B;
        bSliderVal.textContent = B;
      }
      if (!tSlider._locked) {
        tSlider.value = T;
        tSliderVal.textContent = T;
      }
      if (!patternSlider._locked) {
        patternSlider.value = (pat === 0 ? 0 : pat);
        patternSliderVal.textContent = patternSlider.value;
      }

      const sleepOn = sleep === 1;
      sleepToggleBtn.classList.toggle('toggled', sleepOn);

      const modeNames = ['OFF', 'PLAY', 'B-BRIGHT', 'SEQ-SEL', 'LIST-SEL', 'SLEEP', 'DISCO'];
      modeStatus.textContent = modeNames[mode] || `MODE ${mode}`;
      discoBtn.classList.toggle('toggled', mode === 6);

      // List chip highlighting
      listChips.forEach(chip => {
        const idx = parseInt(chip.dataset.list, 10);
        chip.classList.toggle('active', idx === list);
      });
      listName.textContent = listNameFromIndex(list);
    }

    function listNameFromIndex(i) {
      switch (i) {
        case 0: return 'White (0)';
        case 1: return 'Red (1)';
        case 2: return 'Orange (2)';
        case 3: return 'Yellow (3)';
        case 4: return 'Green (4)';
        case 5: return 'Blue (5)';
        case 6: return 'Indigo (6)';
        case 7: return 'Violet (7)';
        case 8: return 'Black / Reactive (8)';
        default: return `List ${i}`;
      }
    }

    // Event wiring
    connectBtn.addEventListener('click', connect);
    disconnectBtn.addEventListener('click', disconnect);

    onBtn.addEventListener('click', () => sendCommand('ON'));
    offBtn.addEventListener('click', () => sendCommand('OFF'));

    discoBtn.addEventListener('click', () => {
      const isOn = discoBtn.classList.toggle('toggled');
      sendCommand(isOn ? 'D1' : 'D0');
    });

    sleepToggleBtn.addEventListener('click', () => {
      const isOn = sleepToggleBtn.classList.toggle('toggled');
      sendCommand(isOn ? 'S1' : 'S0');
    });

    nextPatternBtn.addEventListener('click', () => sendCommand('N'));
    favBtn.addEventListener('click', () => sendCommand('F'));

    bSlider.addEventListener('input', () => {
      bSliderVal.textContent = bSlider.value;
      bSlider._locked = true;
    });
    bSlider.addEventListener('change', () => {
      sendCommand('B' + bSlider.value);
      setTimeout(() => { bSlider._locked = false; }, 200);
    });

    tSlider.addEventListener('input', () => {
      tSliderVal.textContent = tSlider.value;
      tSlider._locked = true;
    });
    tSlider.addEventListener('change', () => {
      sendCommand('T' + tSlider.value);
      setTimeout(() => { tSlider._locked = false; }, 200);
    });

    patternSlider.addEventListener('input', () => {
      patternSliderVal.textContent = patternSlider.value;
      patternSlider._locked = true;
    });
    patternSlider.addEventListener('change', () => {
      sendCommand('I' + patternSlider.value);
      setTimeout(() => { patternSlider._locked = false; }, 200);
    });

    listChips.forEach(chip => {
      chip.addEventListener('click', () => {
        const idx = parseInt(chip.dataset.list, 10);
        sendCommand('L' + idx);
      });
    });

    // Initial UI state
    setConnectedUi(false);
  </script>
</body>
</html>
