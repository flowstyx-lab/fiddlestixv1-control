<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FiddleStyx V1 Control</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #111;
      color: #eee;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 16px;
    }
    h1 {
      font-size: 1.6rem;
      margin-bottom: 8px;
    }
    h2 {
      font-size: 1.1rem;
      margin-top: 16px;
      margin-bottom: 4px;
    }
    button {
      padding: 8px 14px;
      margin: 4px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background: #2d8cff;
      color: #fff;
      font-size: 0.95rem;
    }
    button.secondary {
      background: #444;
    }
    button.danger {
      background: #d9534f;
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
    }
    input[type="number"] {
      width: 60px;
      padding: 4px;
      border-radius: 4px;
      border: 1px solid #444;
      background: #222;
      color: #eee;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 8px;
    }
    .row > * {
      margin-right: 8px;
      margin-bottom: 4px;
    }
    .status {
      font-size: 0.9rem;
      color: #ccc;
      margin-top: 8px;
    }
    #battery-bar {
      height: 10px;
      background: #333;
      border-radius: 5px;
      overflow: hidden;
      margin-top: 4px;
      width: 200px;
    }
    #battery-bar-inner {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #f00, #ff0, #0f0);
    }
    #mic-level-bar {
      height: 10px;
      background: #333;
      border-radius: 5px;
      overflow: hidden;
      width: 200px;
    }
    #mic-level-bar-inner {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #0ff, #09f);
    }
    canvas {
      background: #000;
      border-radius: 6px;
    }
    .small-text {
      font-size: 0.85rem;
      color: #aaa;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>FiddleStyx V1 Control</h1>
    <p class="small-text">
      Connect via Web Bluetooth, send commands, and view live IMU, microphone and battery data.
      For iPhone, you'll need a compatible browser on macOS or another device that supports Web Bluetooth.
    </p>

    <!-- Connection controls -->
    <h2>Connection</h2>
    <div class="row">
      <button id="connect-button">Connect</button>
      <button id="disconnect-button" class="secondary" disabled>Disconnect</button>
      <span id="connection-status" class="status">Not connected</span>
    </div>

    <!-- Basic controls -->
    <h2>Device Controls</h2>
    <div class="row">
      <button id="btn-on">ON</button>
      <button id="btn-off" class="secondary">OFF</button>
      <button id="btn-disco" class="secondary">DISCO (D1)</button>
      <button id="btn-play" class="secondary">Exit DISCO (D0)</button>
    </div>

    <div class="row">
      <label>Brightness (B0-7):</label>
      <input type="number" id="brightness-input" min="0" max="7" value="4" />
      <button id="brightness-set">Set</button>
    </div>

    <div class="row">
      <label>List (L0-7):</label>
      <input type="number" id="list-input" min="0" max="7" value="0" />
      <button id="list-set">Set</button>

      <label>Pattern (I0-49):</label>
      <input type="number" id="pattern-input" min="0" max="49" value="0" />
      <button id="pattern-set">Set</button>

      <button id="pattern-next" class="secondary">Next pattern (N)</button>
    </div>

    <div class="row">
      <label>Sleep:</label>
      <button id="sleep-on" class="secondary">S1 (enable)</button>
      <button id="sleep-off" class="secondary">S0 (disable)</button>
    </div>

    <!-- Battery -->
    <h2>Battery</h2>
    <div class="row">
      <span id="battery-text">Battery: --% (-- V)</span>
    </div>
    <div id="battery-bar">
      <div id="battery-bar-inner"></div>
    </div>

    <!-- Mic level -->
    <h2>Microphone Level</h2>
    <div class="row">
      <span id="mic-text">Level: 0.00</span>
    </div>
    <div id="mic-level-bar">
      <div id="mic-level-bar-inner"></div>
    </div>

    <!-- IMU chart -->
    <h2>IMU Acceleration (g)</h2>
    <p class="small-text">X, Y, Z plotted separately so you can see exactly what the sensor sees.</p>
    <canvas id="imu-chart" width="800" height="300"></canvas>

    <!-- Raw log -->
    <h2>Raw Telemetry Log</h2>
    <pre id="log" style="background:#000; color:#0f0; padding:8px; max-height:200px; overflow:auto; border-radius:6px; font-size:0.8rem;"></pre>
  </div>

  <script>
    // Nordic UART Service UUIDs (Adafruit/Bluefruit style)
    const NUS_SERVICE_UUID        = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
    const NUS_RX_CHARACTERISTIC   = '6e400003-b5a3-f393-e0a9-e50e24dcca9e'; // from peripheral to central (notify)
    const NUS_TX_CHARACTERISTIC   = '6e400002-b5a3-f393-e0a9-e50e24dcca9e'; // from central to peripheral (write)

    let bleDevice           = null;
    let gattServer          = null;
    let txCharacteristic    = null;
    let rxCharacteristic    = null;

    let receiveBuffer       = '';

    const connectButton     = document.getElementById('connect-button');
    const disconnectButton  = document.getElementById('disconnect-button');
    const connStatusSpan    = document.getElementById('connection-status');
    const logElem           = document.getElementById('log');

    const batteryText       = document.getElementById('battery-text');
    const batteryBarInner   = document.getElementById('battery-bar-inner');

    const micText           = document.getElementById('mic-text');
    const micBarInner       = document.getElementById('mic-level-bar-inner');

    // IMU chart setup
    const imuCtx = document.getElementById('imu-chart').getContext('2d');
    const MAX_POINTS = 200;

    const imuData = {
      labels: [],
      ax: [],
      ay: [],
      az: []
    };

    const imuChart = new Chart(imuCtx, {
      type: 'line',
      data: {
        labels: imuData.labels,
        datasets: [
          {
            label: 'Ax (g)',
            data: imuData.ax,
            borderWidth: 1,
            tension: 0.1,
          },
          {
            label: 'Ay (g)',
            data: imuData.ay,
            borderWidth: 1,
            tension: 0.1,
          },
          {
            label: 'Az (g)',
            data: imuData.az,
            borderWidth: 1,
            tension: 0.1,
          }
        ]
      },
      options: {
        animation: false,
        scales: {
          x: {
            ticks: {
              display: false
            }
          },
          y: {
            title: {
              display: true,
              text: 'g'
            }
          }
        },
        plugins: {
          legend: {
            labels: {
              color: '#eee'
            }
          }
        }
      }
    });

    function appendLog(line) {
      logElem.textContent += line + '\n';
      logElem.scrollTop = logElem.scrollHeight;
    }

    async function connect() {
      try {
        const device = await navigator.bluetooth.requestDevice({
          filters: [
            { namePrefix: 'FiddleStIXV1' }
          ],
          optionalServices: [NUS_SERVICE_UUID]
        });

        bleDevice = device;
        bleDevice.addEventListener('gattserverdisconnected', onDisconnected);

        connStatusSpan.textContent = 'Connecting...';
        const server = await bleDevice.gatt.connect();
        gattServer = server;

        const service = await gattServer.getPrimaryService(NUS_SERVICE_UUID);
        rxCharacteristic = await service.getCharacteristic(NUS_RX_CHARACTERISTIC);
        txCharacteristic = await service.getCharacteristic(NUS_TX_CHARACTERISTIC);

        await rxCharacteristic.startNotifications();
        rxCharacteristic.addEventListener('characteristicvaluechanged', handleNotifications);

        connStatusSpan.textContent = 'Connected to ' + bleDevice.name;
        connectButton.disabled = true;
        disconnectButton.disabled = false;

        appendLog('Connected to ' + bleDevice.name);

      } catch (error) {
        console.error(error);
        connStatusSpan.textContent = 'Error: ' + error;
        appendLog('Error: ' + error);
      }
    }

    function onDisconnected() {
      connStatusSpan.textContent = 'Disconnected';
      connectButton.disabled = false;
      disconnectButton.disabled = true;
      txCharacteristic = null;
      rxCharacteristic = null;
    }

    async function disconnect() {
      if (!bleDevice) return;
      if (bleDevice.gatt.connected) {
        await bleDevice.gatt.disconnect();
      }
    }

    function handleNotifications(event) {
      const value = event.target.value;
      const decoder = new TextDecoder('utf-8');
      const text = decoder.decode(value);
      receiveBuffer += text;

      // Process line by line
      let index;
      while ((index = receiveBuffer.indexOf('\n')) >= 0) {
        const line = receiveBuffer.slice(0, index).trim();
        receiveBuffer = receiveBuffer.slice(index + 1);
        if (line.length > 0) {
          parseTelemetryLine(line);
        }
      }
    }

    function parseTelemetryLine(line) {
      appendLog(line);
      const parts = line.split(',');
      if (parts[0] === 'IMU' && parts.length >= 5) {
        const ax = parseFloat(parts[1]);
        const ay = parseFloat(parts[2]);
        const az = parseFloat(parts[3]);
        updateImuChart(ax, ay, az);
      } else if (parts[0] === 'MIC' && parts.length >= 2) {
        const level = parseFloat(parts[1]);
        updateMic(level);
      } else if (parts[0] === 'BAT' && parts.length >= 3) {
        const pct = parseFloat(parts[1]);
        const volt = parseFloat(parts[2]);
        updateBattery(pct, volt);
      }
    }

    function updateImuChart(ax, ay, az) {
      const t = (new Date()).toLocaleTimeString();

      imuData.labels.push(t);
      imuData.ax.push(ax);
      imuData.ay.push(ay);
      imuData.az.push(az);

      if (imuData.labels.length > MAX_POINTS) {
        imuData.labels.shift();
        imuData.ax.shift();
        imuData.ay.shift();
        imuData.az.shift();
      }

      imuChart.update();
    }

    function updateMic(level) {
      if (isNaN(level)) level = 0;
      if (level < 0) level = 0;
      if (level > 1) level = 1;

      micText.textContent = 'Level: ' + level.toFixed(3);
      micBarInner.style.width = (level * 100).toFixed(1) + '%';
    }

    function updateBattery(percent, voltage) {
      if (isNaN(percent)) percent = 0;
      if (isNaN(voltage)) voltage = 0;
      if (percent < 0) percent = 0;
      if (percent > 100) percent = 100;

      batteryText.textContent = 'Battery: ' + percent.toFixed(0) + '% (' + voltage.toFixed(2) + ' V)';
      batteryBarInner.style.width = percent.toFixed(0) + '%';
    }

    async function sendCommand(cmd) {
      if (!txCharacteristic) {
        appendLog('Not connected');
        return;
      }
      const text = cmd + '\n';
      const encoder = new TextEncoder();
      const data = encoder.encode(text);
      try {
        await txCharacteristic.writeValue(data);
        appendLog('> ' + cmd);
      } catch (e) {
        console.error(e);
        appendLog('Error sending: ' + e);
      }
    }

    // UI wiring
    connectButton.addEventListener('click', connect);
    disconnectButton.addEventListener('click', disconnect);

    document.getElementById('btn-on').addEventListener('click', () => sendCommand('ON'));
    document.getElementById('btn-off').addEventListener('click', () => sendCommand('OFF'));
    document.getElementById('btn-disco').addEventListener('click', () => sendCommand('D1'));
    document.getElementById('btn-play').addEventListener('click', () => sendCommand('D0'));

    document.getElementById('brightness-set').addEventListener('click', () => {
      const v = parseInt(document.getElementById('brightness-input').value, 10);
      if (v >= 0 && v <= 7) {
        sendCommand('B' + v);
      }
    });

    document.getElementById('list-set').addEventListener('click', () => {
      const v = parseInt(document.getElementById('list-input').value, 10);
      if (v >= 0 && v <= 7) {
        sendCommand('L' + v);
      }
    });

    document.getElementById('pattern-set').addEventListener('click', () => {
      const v = parseInt(document.getElementById('pattern-input').value, 10);
      if (v >= 0 && v <= 49) {
        sendCommand('I' + v);
      }
    });

    document.getElementById('pattern-next').addEventListener('click', () => {
      sendCommand('N');
    });

    document.getElementById('sleep-on').addEventListener('click', () => sendCommand('S1'));
    document.getElementById('sleep-off').addEventListener('click', () => sendCommand('S0'));
  </script>
</body>
</html>
