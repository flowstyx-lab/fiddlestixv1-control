<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FiddleStix V1 Control</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #05060b;
      color: #f5f5f5;
      margin: 0;
      padding: 16px;
    }
    h1 {
      font-size: 1.6rem;
      margin-bottom: 0.25rem;
    }
    h2 {
      font-size: 1.1rem;
      margin-top: 1.3rem;
      margin-bottom: 0.4rem;
    }
    .card {
      background: #121420;
      border-radius: 12px;
      padding: 12px 14px;
      margin-bottom: 12px;
      box-shadow: 0 0 12px rgba(0,0,0,0.4);
    }
    button {
      margin: 4px;
      padding: 6px 12px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
    }
    button.primary {
      background: #1f8fff;
      color: #fff;
    }
    button.secondary {
      background: #333c55;
      color: #f5f5f5;
    }
    button.danger {
      background: #ff4b5c;
      color: #fff;
    }
    button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    #status {
      font-size: 0.9rem;
      color: #a5b0ff;
      min-height: 1.2rem;
      margin-bottom: 8px;
    }
    #log {
      font-family: monospace;
      font-size: 0.8rem;
      max-height: 200px;
      overflow-y: auto;
      background: #05060b;
      border-radius: 8px;
      padding: 8px;
      border: 1px solid #303448;
    }
    input[type="text"], select {
      padding: 4px 6px;
      border-radius: 6px;
      border: 1px solid #303448;
      background: #05060b;
      color: #f5f5f5;
      font-size: 0.9rem;
      margin: 2px;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 6px;
    }
    .row label {
      margin-right: 4px;
      font-size: 0.85rem;
    }
    .label {
      font-size: 0.8rem;
      color: #9ea6ff;
      margin-right: 4px;
    }
    .value {
      font-family: "SF Mono", Menlo, Monaco, Consolas, monospace;
      font-size: 0.85rem;
      margin-right: 8px;
    }
    .pill {
      display: inline-block;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 0.8rem;
      background: #191b2a;
      margin-right: 6px;
    }
  </style>
</head>
<body>
  <h1>FiddleStix V1 Control</h1>
  <div id="status">Not connected</div>

  <div class="card">
    <h2>Connection</h2>
    <button id="connectBtn" class="primary">Connect to FiddleStIXV1</button>
    <button id="disconnectBtn" class="secondary" disabled>Disconnect</button>
  </div>

  <div class="card">
    <h2>Quick Commands</h2>
    <div class="row">
      <button class="primary" data-cmd="ON">ON</button>
      <button class="danger" data-cmd="OFF">OFF</button>
      <button class="secondary" data-cmd="N">Next pattern (N)</button>
    </div>
    <div class="row">
      <button class="secondary" data-cmd="D1">DISCO ON (D1)</button>
      <button class="secondary" data-cmd="D0">DISCO OFF (D0)</button>
    </div>
    <div class="row">
      <span class="label">Brightness:</span>
      <button class="secondary" data-cmd="B1">B1</button>
      <button class="secondary" data-cmd="B2">B2</button>
      <button class="secondary" data-cmd="B3">B3</button>
      <button class="secondary" data-cmd="B4">B4</button>
      <button class="secondary" data-cmd="B5">B5</button>
      <button class="secondary" data-cmd="B6">B6</button>
      <button class="secondary" data-cmd="B7">B7</button>
    </div>
  </div>

  <div class="card">
    <h2>List & Pattern</h2>
    <div class="row">
      <label for="listSelect">List (L0..L7):</label>
      <select id="listSelect">
        <option value="0">L0</option>
        <option value="1">L1</option>
        <option value="2">L2</option>
        <option value="3">L3</option>
        <option value="4">L4</option>
        <option value="5">L5</option>
        <option value="6">L6</option>
        <option value="7">L7</option>
      </select>
      <button class="secondary" id="setListBtn">Set List</button>
    </div>
    <div class="row">
      <label for="patternInput">Pattern index (0..49):</label>
      <input type="text" id="patternInput" value="0" size="3" />
      <button class="secondary" id="setPatternBtn">Set Pattern</button>
    </div>
  </div>

  <div class="card">
    <h2>Sleep Control</h2>
    <button class="secondary" data-cmd="S1">Sleep Enabled (S1)</button>
    <button class="secondary" data-cmd="S0">Sleep Disabled (S0)</button>
  </div>

  <div class="card">
    <h2>Live Telemetry</h2>
    <div class="row">
      <span class="pill">IMU</span>
      <span class="label">ax:</span><span class="value" id="imuAx">-</span>
      <span class="label">ay:</span><span class="value" id="imuAy">-</span>
      <span class="label">az:</span><span class="value" id="imuAz">-</span>
      <span class="label">|a|:</span><span class="value" id="imuMag">-</span>
    </div>
    <div class="row">
      <span class="pill">MIC</span>
      <span class="label">level:</span><span class="value" id="micLevel">-</span>
      <div style="flex-basis: 100%; height: 4px;"></div>
    </div>
    <div class="row">
      <span class="pill">BAT</span>
      <span class="label">charge:</span><span class="value" id="batPercent">-</span>
      <span class="label">voltage:</span><span class="value" id="batVoltage">-</span>
    </div>
  </div>

  <div class="card">
    <h2>Raw Command</h2>
    <div class="row">
      <input type="text" id="rawCmd" placeholder="Enter command, e.g. B4" />
      <button class="primary" id="sendRawBtn">Send</button>
    </div>
  </div>

  <div class="card">
    <h2>Log</h2>
    <div id="log"></div>
  </div>

  <script>
    const NUS_SERVICE_UUID = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
    const NUS_TX_CHAR_UUID = '6e400003-b5a3-f393-e0a9-e50e24dcca9e'; // Notify from device
    const NUS_RX_CHAR_UUID = '6e400002-b5a3-f393-e0a9-e50e24dcca9e'; // Write to device

    let bleDevice = null;
    let gattServer = null;
    let uartService = null;
    let rxCharacteristic = null;
    let txCharacteristic = null;

    const statusEl = document.getElementById('status');
    const logEl = document.getElementById('log');
    const connectBtn = document.getElementById('connectBtn');
    const disconnectBtn = document.getElementById('disconnectBtn');

    const imuAxEl = document.getElementById('imuAx');
    const imuAyEl = document.getElementById('imuAy');
    const imuAzEl = document.getElementById('imuAz');
    const imuMagEl = document.getElementById('imuMag');
    const micLevelEl = document.getElementById('micLevel');
    const batPercentEl = document.getElementById('batPercent');
    const batVoltageEl = document.getElementById('batVoltage');

    let rxBuffer = '';

    function log(msg) {
      const time = new Date().toLocaleTimeString();
      logEl.innerText = `[${time}] ${msg}\n` + logEl.innerText;
    }

    function setStatus(msg) {
      statusEl.innerText = msg;
      log(msg);
    }

    async function connect() {
      try {
        setStatus('Requesting Bluetooth device...');
        bleDevice = await navigator.bluetooth.requestDevice({
          filters: [{ name: 'FiddleStIXV1' }],
          optionalServices: [NUS_SERVICE_UUID]
        });

        bleDevice.addEventListener('gattserverdisconnected', onDisconnected);

        setStatus('Connecting to GATT server...');
        gattServer = await bleDevice.gatt.connect();

        setStatus('Getting UART service...');
        uartService = await gattServer.getPrimaryService(NUS_SERVICE_UUID);

        setStatus('Getting RX characteristic...');
        rxCharacteristic = await uartService.getCharacteristic(NUS_RX_CHAR_UUID);

        setStatus('Getting TX characteristic...');
        txCharacteristic = await uartService.getCharacteristic(NUS_TX_CHAR_UUID);

        await txCharacteristic.startNotifications();
        txCharacteristic.addEventListener('characteristicvaluechanged', onTxNotification);

        setStatus('Connected to FiddleStIXV1');
        connectBtn.disabled = true;
        disconnectBtn.disabled = false;
      } catch (error) {
        console.error(error);
        setStatus('Connection failed: ' + error);
      }
    }

    function onDisconnected() {
      setStatus('Device disconnected');
      connectBtn.disabled = false;
      disconnectBtn.disabled = true;
      bleDevice = null;
      gattServer = null;
      uartService = null;
      rxCharacteristic = null;
      txCharacteristic = null;
    }

    async function disconnect() {
      if (!bleDevice) return;
      setStatus('Disconnecting...');
      await bleDevice.gatt.disconnect();
      // onDisconnected() will run automatically
    }

    function onTxNotification(event) {
      const value = event.target.value;
      const decoder = new TextDecoder('utf-8');
      const chunk = decoder.decode(value);

      rxBuffer += chunk;
      let lines = rxBuffer.split('\n');
      rxBuffer = lines.pop(); // save incomplete line

      for (let line of lines) {
        const trimmed = line.trim();
        if (!trimmed) continue;
        handleTelemetryLine(trimmed);
      }
    }

    function handleTelemetryLine(line) {
      log('RX: ' + line);
      const parts = line.split(',');
      if (parts[0] === 'IMU' && parts.length >= 5) {
        imuAxEl.textContent = parseFloat(parts[1]).toFixed(3);
        imuAyEl.textContent = parseFloat(parts[2]).toFixed(3);
        imuAzEl.textContent = parseFloat(parts[3]).toFixed(3);
        imuMagEl.textContent = parseFloat(parts[4]).toFixed(3);
      } else if (parts[0] === 'MIC' && parts.length >= 2) {
        micLevelEl.textContent = parseFloat(parts[1]).toFixed(3);
      } else if (parts[0] === 'BAT' && parts.length >= 3) {
        batPercentEl.textContent = parts[1] + '%';
        batVoltageEl.textContent = parseFloat(parts[2]).toFixed(2) + ' V';
      }
    }

    async function sendCommand(cmd) {
      if (!rxCharacteristic) {
        setStatus('Not connected');
        return;
      }
      try {
        const full = cmd.trim() + '\n';
        const data = new TextEncoder().encode(full);
        await rxCharacteristic.writeValue(data);
        log('TX: ' + cmd.trim());
      } catch (err) {
        console.error(err);
        setStatus('Send failed: ' + err);
      }
    }

    // UI wiring
    connectBtn.addEventListener('click', () => {
      if (!navigator.bluetooth) {
        alert('Web Bluetooth not supported in this browser.');
        return;
      }
      connect();
    });

    disconnectBtn.addEventListener('click', () => {
      disconnect();
    });

    document.querySelectorAll('button[data-cmd]').forEach(btn => {
      btn.addEventListener('click', () => {
        const cmd = btn.getAttribute('data-cmd');
        sendCommand(cmd);
      });
    });

    document.getElementById('sendRawBtn').addEventListener('click', () => {
      const cmd = document.getElementById('rawCmd').value;
      if (cmd) sendCommand(cmd);
    });

    document.getElementById('setListBtn').addEventListener('click', () => {
      const val = document.getElementById('listSelect').value;
      const cmd = 'L' + val;
      sendCommand(cmd);
    });

    document.getElementById('setPatternBtn').addEventListener('click', () => {
      const val = document.getElementById('patternInput').value.trim();
      const n = parseInt(val, 10);
      if (isNaN(n) || n < 0 || n > 49) {
        alert('Pattern must be 0..49');
        return;
      }
      const cmd = 'I' + n;
      sendCommand(cmd);
    });
  </script>
</body>
</html>


