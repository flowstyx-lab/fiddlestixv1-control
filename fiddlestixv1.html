<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FiddleStIX V1 Control</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root { color-scheme: dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; padding: 16px; background:#0b0f14; color:#e8eef7; }
    .row { display:flex; gap:10px; flex-wrap: wrap; align-items: center; }
    .card { background:#121926; border:1px solid #1f2a3a; border-radius:12px; padding:12px; margin:10px 0; }
    button { background:#1f6feb; border:none; color:white; padding:10px 12px; border-radius:10px; cursor:pointer; }
    button.secondary { background:#2d3646; }
    button.danger { background:#d73a49; }
    button:disabled { opacity:0.5; cursor:not-allowed; }
    .pill { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; background:#0f1623; border:1px solid #1f2a3a; }
    .dot { width:10px; height:10px; border-radius:50%; background:#777; }
    input[type="range"] { width: 260px; }
    .lists { display:flex; gap:8px; flex-wrap: wrap; }
    .listCircle { width:18px; height:18px; border-radius:50%; border:1px solid #fff3; cursor:pointer; }
    .grid { display:grid; grid-template-columns: 1fr; gap:12px; }
    @media (min-width: 1000px) { .grid { grid-template-columns: 1fr 1fr; } }
    .small { font-size: 12px; opacity:0.8; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
  </style>
</head>
<body>
  <h2>FiddleStIX V1 Control</h2>

  <div class="card">
    <div class="row">
      <button id="connectBtn">Connect</button>
      <span class="pill"><span id="connDot" class="dot"></span><span id="connText">Disconnected</span></span>
      <span class="pill mono" id="deviceName">—</span>
      <span class="pill">State: <b id="stateText">—</b></span>
      <span class="pill">List: <b id="listText">—</b></span>
      <span class="pill">Pattern: <b id="patternText">—</b></span>
      <span class="pill">RX: <b id="hzText">—</b> Hz</span>
    </div>

    <div style="margin-top:10px" class="row">
      <div>
        <div class="small">Lists (click to set) — GUI shows 1–9, device uses 0–8</div>
        <div class="lists" id="lists"></div>
      </div>

      <div>
        <div class="small">Pattern (GUI 1–100, device 0–99)</div>
        <input id="patternSlider" type="range" min="1" max="100" value="1">
        <span class="mono" id="patternSliderVal">1</span>
      </div>
    </div>

    <div style="margin-top:10px" class="row">
      <button id="prevListBtn" class="secondary">Previous Page</button>
      <button id="nextListBtn" class="secondary">Next Page</button>
      <button id="prevPatternBtn" class="secondary">Previous Pattern</button>
      <button id="nextPatternBtn" class="secondary">Next Pattern</button>
      <button id="favoriteBtn" class="secondary">Favorite</button>
      <button id="sleepBtn" class="secondary">Go To Sleep</button>
      <button id="raveBtn" class="secondary">Rave O’Clock</button>
      <button id="offBtn" class="danger">OFF</button>
    </div>

    <div style="margin-top:10px" class="row">
      <div>
        <div class="small">Global Brightness (0–255)</div>
        <input id="brightnessSlider" type="range" min="0" max="255" value="128">
        <span class="mono" id="brightnessVal">128</span>
      </div>
      <div>
        <div class="small">Shuffle T (ms)</div>
        <input id="shuffleSlider" type="range" min="1000" max="60000" step="250" value="8000">
        <span class="mono" id="shuffleVal">8000</span>
      </div>
    </div>

    <div style="margin-top:10px" class="row">
      <button id="toggleShuffleP" class="secondary">Toggle Shuffle_P</button>
      <button id="toggleSleepTimer" class="secondary">Toggle SleepTimer</button>
      <button id="togglePowerLock" class="secondary">Toggle PowerLock</button>
    </div>

    <div class="small" style="margin-top:10px">
      Incoming telemetry:
      <span class="mono">SAMP2,ms,role,state,list,pat,axP,ayP,azP,axS,ayS,azS,gxP,gyP,gzP,micP,micS</span>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <h3>Accelerometer magnitude — Primary vs Secondary</h3>
      <canvas id="accelChart" height="160"></canvas>
    </div>
    <div class="card">
      <h3>Gyroscope magnitude (Primary only)</h3>
      <canvas id="gyroChart" height="160"></canvas>
    </div>
    <div class="card">
      <h3>Mic — Primary vs Secondary</h3>
      <canvas id="micChart" height="160"></canvas>
    </div>
    <div class="card">
      <h3>Latest line</h3>
      <pre id="raw" class="mono" style="white-space:pre-wrap; word-break:break-word;"></pre>
    </div>
  </div>

<script>
  const UART_SERVICE = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
  const UART_TX      = '6e400002-b5a3-f393-e0a9-e50e24dcca9e';
  const UART_RX      = '6e400003-b5a3-f393-e0a9-e50e24dcca9e';

  let device, server, service, txChar, rxChar;
  let rxBuf = '';

  const connDot = document.getElementById('connDot');
  const connText = document.getElementById('connText');
  const deviceNameEl = document.getElementById('deviceName');
  const stateText = document.getElementById('stateText');
  const listText = document.getElementById('listText');
  const patternText = document.getElementById('patternText');
  const rawEl = document.getElementById('raw');
  const hzText = document.getElementById('hzText');

  const patternSlider = document.getElementById('patternSlider');
  const patternSliderVal = document.getElementById('patternSliderVal');
  const brightnessSlider = document.getElementById('brightnessSlider');
  const brightnessVal = document.getElementById('brightnessVal');
  const shuffleSlider = document.getElementById('shuffleSlider');
  const shuffleVal = document.getElementById('shuffleVal');

  const stateNames = ["OFF","PLAY","SLEEP","SHUFFLE","PAIRING","L_SELECT","B_SELECT","T_SELECT"];
  const listColors = ['#ffffff','#ff3b30','#ff9500','#ffcc00','#34c759','#0a84ff','#5e5ce6','#bf5af2','#111111'];

  const listsDiv = document.getElementById('lists');
  listColors.forEach((c, idx) => {
    const d = document.createElement('div');
    d.className = 'listCircle';
    d.style.background = c;
    d.title = `List ${idx+1}`;
    d.onclick = () => sendLine(`SET:LIST:${idx}`);
    listsDiv.appendChild(d);
  });

  const MAX_SECONDS = 30;
  const accelP = [], accelS = [], gyroP = [], micP = [], micS = [];

  function makeChart(ctx, datasets) {
    return new Chart(ctx, {
      type: 'line',
      data: { datasets },
      options: {
        parsing: false,
        animation: false,
        normalized: true,
        scales: {
          x: { type: 'linear', title: { display: true, text: 'seconds (rolling)' } },
          y: { title: { display: true, text: 'value' } }
        },
        plugins: { legend: { display: true } },
        elements: { point: { radius: 0 } }
      }
    });
  }

  const accelChart = makeChart(document.getElementById('accelChart'), [
    { label:'Primary', data: accelP, borderColor:'#4aa3ff', tension:0.15 },
    { label:'Secondary', data: accelS, borderColor:'#ff5a5a', tension:0.15 }
  ]);
  const gyroChart  = makeChart(document.getElementById('gyroChart'), [
    { label:'Gyro', data: gyroP, borderColor:'#4aa3ff', tension:0.15 }
  ]);
  const micChart   = makeChart(document.getElementById('micChart'), [
    { label:'Primary', data: micP, borderColor:'#4aa3ff', tension:0.15 },
    { label:'Secondary', data: micS, borderColor:'#ff5a5a', tension:0.15 }
  ]);

  function setConnectedUI(ok) {
    connDot.style.background = ok ? '#34c759' : '#777';
    connText.textContent = ok ? 'Connected' : 'Disconnected';
  }

  async function connect() {
    device = await navigator.bluetooth.requestDevice({
      filters: [{ name: 'FiddleStIX_V1' }],
      optionalServices: [UART_SERVICE]
    });

    deviceNameEl.textContent = device.name || '(unnamed)';
    device.addEventListener('gattserverdisconnected', () => setConnectedUI(false));

    server = await device.gatt.connect();
    service = await server.getPrimaryService(UART_SERVICE);
    txChar = await service.getCharacteristic(UART_TX);
    rxChar = await service.getCharacteristic(UART_RX);

    await rxChar.startNotifications();
    rxChar.addEventListener('characteristicvaluechanged', onNotify);

    setConnectedUI(true);
  }

  function onNotify(e) {
    const chunk = new TextDecoder().decode(e.target.value);
    rxBuf += chunk;

    let idx;
    while ((idx = rxBuf.indexOf('\n')) >= 0) {
      const line = rxBuf.slice(0, idx).trim();
      rxBuf = rxBuf.slice(idx + 1);
      if (line) handleLine(line);
    }
  }

  // RX rate
  let lastRateMs = performance.now();
  let rateCount = 0;

  function handleLine(line) {
    rawEl.textContent = line;

    if (line.startsWith('SAMP2,')) {
      rateCount++;
      const now = performance.now();
      if (now - lastRateMs >= 1000) {
        hzText.textContent = (rateCount / ((now - lastRateMs)/1000)).toFixed(1);
        lastRateMs = now;
        rateCount = 0;
      }
    } else return;

    const parts = line.split(',');
    if (parts.length < 17) return;

    const ms = Number(parts[1]);
    const state = Number(parts[3]);
    const list = Number(parts[4]);
    const pat = Number(parts[5]);

    const axP_ = Number(parts[6]), ayP_ = Number(parts[7]), azP_ = Number(parts[8]);
    const axS_ = Number(parts[9]), ayS_ = Number(parts[10]), azS_ = Number(parts[11]);
    const gx_ = Number(parts[12]), gy_ = Number(parts[13]), gz_ = Number(parts[14]);
    const micP_ = Number(parts[15]), micS_ = Number(parts[16]);

    stateText.textContent = stateNames[state] || state;
    listText.textContent = `${list+1}`;
    patternText.textContent = `${pat+1}`;

    const t = ms / 1000;
    const aMagP = Math.hypot(axP_, ayP_, azP_);
    const aMagS = Math.hypot(axS_, ayS_, azS_);
    const gMag  = Math.hypot(gx_, gy_, gz_);

    pushRolling(accelP, t, aMagP);
    pushRolling(accelS, t, aMagS);
    pushRolling(gyroP,  t, gMag);
    pushRolling(micP,   t, micP_);
    pushRolling(micS,   t, micS_);

    accelChart.update('none');
    gyroChart.update('none');
    micChart.update('none');
  }

  function pushRolling(arr, t, y) {
    arr.push({ x: t, y });
    const minT = t - MAX_SECONDS;
    while (arr.length && arr[0].x < minT) arr.shift();
  }

  async function sendLine(line) {
    if (!txChar) return;
    const data = new TextEncoder().encode(line + '\n');
    await txChar.writeValue(data);
  }

  document.getElementById('connectBtn').onclick = connect;

  // Buttons
  document.getElementById('nextListBtn').onclick = () => sendLine('CMD:NEXT_LIST');
  document.getElementById('prevListBtn').onclick = () => sendLine('CMD:PREV_LIST');
  document.getElementById('nextPatternBtn').onclick = () => sendLine('CMD:NEXT_PATTERN');
  document.getElementById('prevPatternBtn').onclick = () => sendLine('CMD:PREV_PATTERN');
  document.getElementById('favoriteBtn').onclick = () => sendLine('CMD:FAVORITE');
  document.getElementById('sleepBtn').onclick = () => sendLine('CMD:GOTO_SLEEP');
  document.getElementById('raveBtn').onclick = () => sendLine('CMD:RAVE_TIME');
  document.getElementById('offBtn').onclick = () => sendLine('CMD:OFF');

  // Slider mapping: GUI 1..100 => device 0..99
  patternSlider.oninput = () => { patternSliderVal.textContent = patternSlider.value; };
  patternSlider.onchange = () => {
    const v = Math.max(1, Math.min(100, Number(patternSlider.value)));
    sendLine(`SET:PATTERN:${v-1}`);
  };

  brightnessSlider.oninput = () => {
    brightnessVal.textContent = brightnessSlider.value;
    sendLine(`SET:BRIGHTNESS:${brightnessSlider.value}`);
  };

  shuffleSlider.oninput = () => {
    shuffleVal.textContent = shuffleSlider.value;
    sendLine(`SET:SHUFFLE_T:${shuffleSlider.value}`);
  };

  document.getElementById('toggleShuffleP').onclick = () => sendLine('TOGGLE:SHUFFLE_P');
  document.getElementById('toggleSleepTimer').onclick = () => sendLine('TOGGLE:SLEEPTIMER');
  document.getElementById('togglePowerLock').onclick = () => sendLine('TOGGLE:POWERLOCK');

  setConnectedUI(false);
</script>
</body>
</html>
