<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>FiddleStIX V1 Control</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      background: #111;
      color: #eee;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0;
      padding: 0;
    }
    header {
      padding: 1rem;
      background: #222;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    h1 {
      font-size: 1.2rem;
      margin: 0;
    }
    button {
      padding: 0.4rem 0.8rem;
      margin: 0.2rem;
      border-radius: 4px;
      border: none;
      background: #444;
      color: #eee;
      cursor: pointer;
    }
    button:hover {
      background: #666;
    }
    button.connected {
      background: #2a8f2a;
    }
    .container {
      padding: 1rem;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      grid-gap: 1rem;
    }
    .card {
      background: #1b1b1b;
      border-radius: 8px;
      padding: 0.8rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.4);
    }
    .card h2 {
      margin-top: 0;
      font-size: 1rem;
      border-bottom: 1px solid #333;
      padding-bottom: 0.3rem;
    }
    .btn-row {
      display: flex;
      flex-wrap: wrap;
    }
    label {
      font-size: 0.85rem;
    }
    input[type="range"] {
      width: 100%;
    }
    .list-colors {
      display: flex;
      flex-wrap: wrap;
      gap: 0.3rem;
      margin-top: 0.5rem;
    }
    .list-dot {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 2px solid #444;
      cursor: pointer;
      box-sizing: border-box;
    }
    .list-dot.active {
      border-color: #fff;
      box-shadow: 0 0 4px rgba(255,255,255,0.8);
    }
    canvas {
      width: 100%;
      height: 120px;
      background: #000;
      border-radius: 4px;
    }
    .status-line {
      font-size: 0.9rem;
      margin-top: 0.5rem;
    }
    .toggle-btn {
      background: #444;
    }
    .toggle-btn.on {
      background: #2a8f2a;
    }
    .field-line {
      display: flex;
      justify-content: space-between;
      font-size: 0.8rem;
      margin-top: 0.2rem;
    }
  </style>
</head>
<body>
<header>
  <h1>FiddleStIX V1 Control</h1>
  <button id="connectBtn">Connect</button>
</header>

<div class="container">
  <!-- Transport controls -->
  <div class="card">
    <h2>Playback & Control</h2>
    <div class="btn-row">
      <button id="prevPageBtn">Previous Page</button>
      <button id="nextPageBtn">Next Page</button>
      <button id="prevPatternBtn">Previous Pattern</button>
      <button id="nextPatternBtn">Next Pattern</button>
    </div>
    <div class="btn-row">
      <button id="favoriteBtn">Favorite</button>
      <button id="sleepBtn">Go To Sleep</button>
      <button id="raveBtn">Rave O'Clock</button>
    </div>
    <div class="status-line">
      List: <span id="listLabel">?</span> |
      Pattern: <span id="patternLabel">?</span> |
      State: <span id="stateLabel">?</span>
    </div>
  </div>

  <!-- List & pattern selection -->
  <div class="card">
    <h2>List & Pattern Selection</h2>
    <label>Lists:</label>
    <div class="list-colors" id="listDots">
      <!-- Populated in JS -->
    </div>
    <div style="margin-top:0.8rem;">
      <label for="patternSlider">Pattern Index</label>
      <input type="range" id="patternSlider" min="0" max="4" value="0">
      <div class="field-line">
        <span>0</span><span>4</span>
      </div>
      <button id="setPatternBtn" style="margin-top:0.4rem;">Set Pattern</button>
    </div>
  </div>

  <!-- Settings -->
  <div class="card">
    <h2>Settings</h2>
    <label for="brightnessSlider">Global Brightness</label>
    <input type="range" id="brightnessSlider" min="0" max="7" value="7">
    <div class="field-line">
      <span>10%</span><span>100%</span>
    </div>

    <label for="shuffleSlider" style="margin-top:0.8rem; display:block;">Shuffle Dwell (ms)</label>
    <input type="range" id="shuffleSlider" min="200" max="10000" step="100" value="2000">
    <div class="field-line">
      <span>200</span><span>10000</span>
    </div>

    <div style="margin-top:0.8rem;">
      <button class="toggle-btn" id="toggleSleepTimerBtn">Sleep Timer</button>
      <button class="toggle-btn" id="togglePowerLockBtn">Power Lock</button>
      <button class="toggle-btn" id="toggleShuffleBtn">Shuffle</button>
    </div>
  </div>

  <!-- Graphs: Gyro, Accel, Mic -->
  <div class="card">
    <h2>Gyro</h2>
    <canvas id="gyroCanvas" width="300" height="120"></canvas>
  </div>

  <div class="card">
    <h2>Acceleration</h2>
    <canvas id="accelCanvas" width="300" height="120"></canvas>
  </div>

  <div class="card">
    <h2>Mic Level</h2>
    <canvas id="micCanvas" width="300" height="120"></canvas>
  </div>
</div>

<script>
  // BLE UUIDs for Nordic UART (Adafruit Bluefruit style)
  const UART_SERVICE_UUID = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
  const UART_RX_UUID      = '6e400002-b5a3-f393-e0a9-e50e24dcca9e'; // write
  const UART_TX_UUID      = '6e400003-b5a3-f393-e0a9-e50e24dcca9e'; // notify

  let device, server, uartService, rxCharacteristic, txCharacteristic;
  let connected = false;

  const connectBtn = document.getElementById('connectBtn');
  const prevPageBtn = document.getElementById('prevPageBtn');
  const nextPageBtn = document.getElementById('nextPageBtn');
  const prevPatternBtn = document.getElementById('prevPatternBtn');
  const nextPatternBtn = document.getElementById('nextPatternBtn');
  const favoriteBtn = document.getElementById('favoriteBtn');
  const sleepBtn = document.getElementById('sleepBtn');
  const raveBtn = document.getElementById('raveBtn');

  const listLabel = document.getElementById('listLabel');
  const patternLabel = document.getElementById('patternLabel');
  const stateLabel = document.getElementById('stateLabel');

  const listDotsContainer = document.getElementById('listDots');
  const patternSlider = document.getElementById('patternSlider');
  const setPatternBtn = document.getElementById('setPatternBtn');

  const brightnessSlider = document.getElementById('brightnessSlider');
  const shuffleSlider = document.getElementById('shuffleSlider');

  const toggleSleepTimerBtn = document.getElementById('toggleSleepTimerBtn');
  const togglePowerLockBtn = document.getElementById('togglePowerLockBtn');
  const toggleShuffleBtn = document.getElementById('toggleShuffleBtn');

  // Graphs
  const gyroCanvas = document.getElementById('gyroCanvas');
  const accelCanvas = document.getElementById('accelCanvas');
  const micCanvas = document.getElementById('micCanvas');

  const gyroCtx = gyroCanvas.getContext('2d');
  const accelCtx = accelCanvas.getContext('2d');
  const micCtx = micCanvas.getContext('2d');

  let gyroData = [];
  let accelData = [];
  let micData = [];
  const MAX_POINTS = 200;

  let currentList = 0;
  let currentPattern = 0;
  let currentState = 0;

  const LIST_NAMES = [
    'WHITE','RED','ORANGE','YELLOW','GREEN','BLUE','INDIGO','VIOLET','BLACK'
  ];

  const LIST_COLORS = [
    '#ffffff', // WHITE
    '#ff0000', // RED
    '#ff7f00', // ORANGE
    '#ffff00', // YELLOW
    '#00ff00', // GREEN
    '#0000ff', // BLUE
    '#4b0082', // INDIGO
    '#8f00ff', // VIOLET
    '#000000'  // BLACK
  ];

  function log(msg) {
    console.log('[FiddleStIX]', msg);
  }

  async function connect() {
    try {
      device = await navigator.bluetooth.requestDevice({
        filters: [{ namePrefix: 'FiddleStIX_V1' }],
        optionalServices: [UART_SERVICE_UUID]
      });
      device.addEventListener('gattserverdisconnected', onDisconnected);
      server = await device.gatt.connect();
      uartService = await server.getPrimaryService(UART_SERVICE_UUID);
      rxCharacteristic = await uartService.getCharacteristic(UART_RX_UUID);
      txCharacteristic = await uartService.getCharacteristic(UART_TX_UUID);
      await txCharacteristic.startNotifications();
      txCharacteristic.addEventListener('characteristicvaluechanged', handleNotifications);
      connected = true;
      connectBtn.textContent = 'Connected';
      connectBtn.classList.add('connected');
      log('Connected to device');
    } catch (error) {
      console.error(error);
      alert('Connection failed: ' + error);
    }
  }

  function onDisconnected() {
    connected = false;
    connectBtn.textContent = 'Connect';
    connectBtn.classList.remove('connected');
    log('Disconnected');
  }

  async function sendCommand(str) {
    if (!connected || !rxCharacteristic) {
      alert('Not connected');
      return;
    }
    const enc = new TextEncoder();
    const data = enc.encode(str + '\n');
    try {
      await rxCharacteristic.writeValue(data);
    } catch (e) {
      console.error('write error', e);
    }
  }

  function handleNotifications(event) {
    const decoder = new TextDecoder();
    const text = decoder.decode(event.target.value);
    // data may contain multiple lines
    const lines = text.split('\n');
    for (const line of lines) {
      if (!line.trim()) continue;
      try {
        const obj = JSON.parse(line);
        handleTelemetry(obj);
      } catch (e) {
        // not JSON, ignore
      }
    }
  }

  function handleTelemetry(t) {
    if (typeof t.list === 'number') {
      currentList = t.list;
      updateListUI();
    }
    if (typeof t.pattern === 'number') {
      currentPattern = t.pattern;
      patternSlider.value = currentPattern;
      patternLabel.textContent = currentPattern.toString();
    }
    if (typeof t.state === 'number') {
      currentState = t.state;
      stateLabel.textContent = currentState.toString();
    }

    // magnitude values for graphs
    if (typeof t.gx === 'number' && typeof t.gy === 'number' && typeof t.gz === 'number') {
      const gmag = Math.sqrt(t.gx*t.gx + t.gy*t.gy + t.gz*t.gz);
      addDataPoint(gyroData, gmag);
      drawGraph(gyroCtx, gyroCanvas, gyroData, 'Gyro');
    }
    if (typeof t.ax === 'number' && typeof t.ay === 'number' && typeof t.az === 'number') {
      const amag = Math.sqrt(t.ax*t.ax + t.ay*t.ay + t.az*t.az);
      addDataPoint(accelData, amag);
      drawGraph(accelCtx, accelCanvas, accelData, 'Accel');
    }
    if (typeof t.mic === 'number') {
      addDataPoint(micData, t.mic);
      drawGraph(micCtx, micCanvas, micData, 'Mic');
    }

    listLabel.textContent = LIST_NAMES[currentList] || currentList.toString();
  }

  function addDataPoint(arr, val) {
    arr.push(val);
    if (arr.length > MAX_POINTS) arr.shift();
  }

  function drawGraph(ctx, canvas, data, label) {
    const w = canvas.width;
    const h = canvas.height;
    ctx.clearRect(0, 0, w, h);
    ctx.fillStyle = '#000';
    ctx.fillRect(0, 0, w, h);

    if (data.length < 2) return;

    const maxVal = Math.max(...data) || 1;
    const minVal = Math.min(...data) || 0;
    const range = (maxVal - minVal) || 1;

    ctx.beginPath();
    ctx.strokeStyle = '#00ff88';
    ctx.lineWidth = 1;
    const step = w / (MAX_POINTS - 1);
    data.forEach((v, i) => {
      const x = i * step;
      const y = h - ((v - minVal) / range) * h;
      if (i === 0) ctx.moveTo(x, y);
      else ctx.lineTo(x, y);
    });
    ctx.stroke();

    ctx.fillStyle = '#888';
    ctx.font = '10px system-ui';
    ctx.fillText(label, 4, 12);
  }

  function updateListUI() {
    const dots = listDotsContainer.querySelectorAll('.list-dot');
    dots.forEach((dot, i) => {
      dot.classList.toggle('active', i === currentList);
    });
    listLabel.textContent = LIST_NAMES[currentList] || currentList.toString();
    patternLabel.textContent = currentPattern.toString();
  }

  // Build list color dots
  function initListDots() {
    LIST_COLORS.forEach((col, idx) => {
      const div = document.createElement('div');
      div.className = 'list-dot';
      div.style.backgroundColor = col;
      div.title = LIST_NAMES[idx];
      div.addEventListener('click', () => {
        currentList = idx;
        updateListUI();
        sendCommand(`CMD:SET_PATTERN:${currentList},${currentPattern}`);
      });
      listDotsContainer.appendChild(div);
    });
    updateListUI();
  }

  // Event handlers
  connectBtn.addEventListener('click', () => {
    if (!connected) {
      connect();
    } else if (device && device.gatt.connected) {
      device.gatt.disconnect();
    }
  });

  prevPageBtn.addEventListener('click', () => sendCommand('CMD:PREV_LIST'));
  nextPageBtn.addEventListener('click', () => sendCommand('CMD:NEXT_LIST'));
  prevPatternBtn.addEventListener('click', () => sendCommand('CMD:PREV_PATTERN'));
  nextPatternBtn.addEventListener('click', () => sendCommand('CMD:NEXT_PATTERN'));
  favoriteBtn.addEventListener('click', () => sendCommand('CMD:FAVORITE'));
  sleepBtn.addEventListener('click', () => sendCommand('CMD:SLEEP'));
  raveBtn.addEventListener('click', () => sendCommand('CMD:RAVE'));

  setPatternBtn.addEventListener('click', () => {
    currentPattern = parseInt(patternSlider.value, 10);
    patternLabel.textContent = currentPattern.toString();
    sendCommand(`CMD:SET_PATTERN:${currentList},${currentPattern}`);
  });

  brightnessSlider.addEventListener('change', () => {
    const val = parseInt(brightnessSlider.value, 10);
    sendCommand(`CMD:SET_BRIGHT:${val}`);
  });

  shuffleSlider.addEventListener('change', () => {
    const val = parseInt(shuffleSlider.value, 10);
    sendCommand(`CMD:SET_SHUF_T:${val}`);
  });

  toggleSleepTimerBtn.addEventListener('click', () => {
    toggleSleepTimerBtn.classList.toggle('on');
    sendCommand('CMD:TOGGLE:sleepTimer');
  });

  togglePowerLockBtn.addEventListener('click', () => {
    togglePowerLockBtn.classList.toggle('on');
    sendCommand('CMD:TOGGLE:powerLock');
  });

  toggleShuffleBtn.addEventListener('click', () => {
    toggleShuffleBtn.classList.toggle('on');
    sendCommand('CMD:TOGGLE:shuffle_P');
  });

  // Init
  initListDots();
</script>
</body>
</html>
