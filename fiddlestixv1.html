<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>LEDStyx Control GUI</title>
  <style>
    body {
      background: #050510;
      color: #f5f5f5;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 20px;
    }

    h1, h2 {
      margin: 0 0 10px 0;
    }

    h1 {
      font-size: 1.8rem;
    }
    h2 {
      font-size: 1.2rem;
      margin-top: 20px;
    }

    .flex-row {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: center;
    }

    .card {
      background: #111323;
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 0 10px rgba(0,0,0,0.4);
    }

    .device-card {
      flex: 1 1 260px;
    }

    button {
      background: #2c3fe0;
      color: white;
      border: none;
      padding: 8px 14px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      margin: 4px 4px 4px 0;
    }

    button.secondary {
      background: #333a5a;
    }

    button.danger {
      background: #e03b4d;
    }

    button:disabled {
      opacity: 0.4;
      cursor: default;
    }

    .slider-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 4px 0;
    }

    input[type="range"] {
      width: 180px;
    }

    label {
      font-size: 0.85rem;
    }

    .toggle-group label {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-right: 12px;
    }

    .log {
      width: 100%;
      height: 180px;
      background: #050713;
      color: #9fdcff;
      font-family: "SF Mono", "Consolas", monospace;
      font-size: 0.8rem;
      border-radius: 8px;
      padding: 8px;
      box-sizing: border-box;
      overflow-y: auto;
      white-space: pre-wrap;
    }

    .small {
      font-size: 0.75rem;
      opacity: 0.7;
    }

    .row-spaced {
      display: flex;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
    }

    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.7rem;
      background: #20253f;
      color: #a2b1ff;
      margin-left: 4px;
    }

  </style>
</head>
<body>
  <h1>LEDStyx Control GUI</h1>
  <p class="small">
    Connect up to two sticks and control them <strong>simultaneously</strong>.
    All controls send matching commands to every connected device.
  </p>

  <!-- Device connection cards -->
  <div class="flex-row">
    <div class="card device-card">
      <h2>Stick A <span id="statusA" class="pill">disconnected</span></h2>
      <button id="connectA">Connect Stick A</button>
      <button id="disconnectA" class="danger" disabled>Disconnect</button>
      <p class="small" id="infoA"></p>
    </div>

    <div class="card device-card">
      <h2>Stick B <span id="statusB" class="pill">disconnected</span></h2>
      <button id="connectB">Connect Stick B</button>
      <button id="disconnectB" class="danger" disabled>Disconnect</button>
      <p class="small" id="infoB"></p>
    </div>
  </div>

  <!-- Pattern / list navigation -->
  <div class="card">
    <h2>Lists &amp; Patterns</h2>
    <div class="flex-row">
      <div>
        <p class="small">Quick list controls</p>
        <button id="prevList">‚üµ Prev List</button>
        <button id="nextList">Next List ‚ü∂</button>
      </div>

      <div>
        <p class="small">Quick pattern controls</p>
        <button id="prevPattern">‚üµ Prev Pattern</button>
        <button id="nextPattern">Next Pattern ‚ü∂</button>
      </div>

      <div>
        <p class="small">Direct selection</p>
        <div class="slider-row">
          <label for="listIndex">List #</label>
          <input id="listIndex" type="number" min="0" max="7" value="0" />
          <button id="setList" class="secondary">SET:LIST</button>
        </div>
        <div class="slider-row">
          <label for="patternIndex">Pattern #</label>
          <input id="patternIndex" type="number" min="0" max="19" value="0" />
          <button id="setPattern" class="secondary">SET:PATTERN</button>
        </div>
      </div>
    </div>

    <div style="margin-top:8px;">
      <button id="favorite" class="secondary">‚≠ê FAVORITE (Whitelist)</button>
    </div>
  </div>

  <!-- Brightness & T controls -->
  <div class="card">
    <h2>Brightness &amp; Shuffle Time</h2>
    <div class="row-spaced">

      <div>
        <p class="small">Global brightness (0‚Äì7 ‚Üí <code>SET:BRIGHT</code>)</p>
        <div class="slider-row">
          <label for="brightSlider">Brightness:</label>
          <input id="brightSlider" type="range" min="0" max="7" value="4" />
          <span id="brightLabel">4</span>
          <button id="brightSend" class="secondary">Send</button>
        </div>
      </div>

      <div>
        <p class="small">Shuffle T (seconds ‚Üí ms, <code>SET:SHUFFLE_T</code>)</p>
        <div class="slider-row">
          <label for="tSlider">T (s):</label>
          <!-- 0.5s to 10s, mapped to 500‚Äì10000 ms in code -->
          <input id="tSlider" type="range" min="5" max="100" value="30" />
          <span id="tLabel">3.0 s (3000 ms)</span>
          <button id="tSend" class="secondary">Send</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Flags / special commands -->
  <div class="card">
    <h2>Flags &amp; Special Modes</h2>

    <div class="toggle-group">
      <p class="small">Boolean flags (<code>SET:BOOL:name:0/1</code>)</p>
      <label>
        <input type="checkbox" id="flagShuffle" />
        shuffle
      </label>
      <label>
        <input type="checkbox" id="flagSleepTimer" />
        sleepTimer
      </label>
      <label>
        <input type="checkbox" id="flagPowerLock" />
        powerLock
      </label>
      <button id="sendFlags" class="secondary">Send Flags</button>
    </div>

    <div style="margin-top:10px;">
      <button id="goSleep" class="secondary">üí§ GO_SLEEP</button>
      <button id="rave" class="secondary">üéâ RAVE</button>
    </div>
  </div>

  <!-- Raw / debug -->
  <div class="card">
    <h2>Raw Command &amp; Log</h2>
    <div class="flex-row" style="align-items:flex-start;">
      <div style="flex:1 1 260px;">
        <p class="small">Send a raw text line (e.g. <code>RAW:...</code>, <code>CMD:...</code>, <code>SET:...</code>)</p>
        <input id="rawInput" type="text" style="width:100%; margin-bottom:4px;" placeholder="e.g. CMD:NEXT_PATTERN" />
        <button id="rawSend">Send Raw</button>
      </div>
      <div style="flex:2 1 320px;">
        <p class="small">Device log (RX + TX)</p>
        <div id="log" class="log"></div>
      </div>
    </div>
  </div>

  <script>
    // === UUIDs for Adafruit Bluefruit UART service ===
    const UART_SERVICE_UUID = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
    const UART_TX_UUID      = "6e400002-b5a3-f393-e0a9-e50e24dcca9e"; // central writes here
    const UART_RX_UUID      = "6e400003-b5a3-f393-e0a9-e50e24dcca9e"; // notifications from peripheral

    const encoder = new TextEncoder();

    // Per-stick connection state
    const sticks = {
      A: { device: null, server: null, txChar: null, rxChar: null },
      B: { device: null, server: null, txChar: null, rxChar: null }
    };

    const logElem = document.getElementById("log");

    function log(msg) {
      const time = new Date().toLocaleTimeString();
      logElem.textContent += `[${time}] ${msg}\n`;
      logElem.scrollTop = logElem.scrollHeight;
    }

    async function connectStick(key) {
      const statusElem = document.getElementById(`status${key}`);
      const infoElem = document.getElementById(`info${key}`);
      const connectBtn = document.getElementById(`connect${key}`);
      const disconnectBtn = document.getElementById(`disconnect${key}`);

      try {
        // IMPORTANT: use filters *without* acceptAllDevices
        const device = await navigator.bluetooth.requestDevice({
          filters: [
            { services: [UART_SERVICE_UUID] }
            // If you want to further restrict by name:
            // { namePrefix: "LEDStyx" }
          ]
        });

        sticks[key].device = device;

        device.addEventListener("gattserverdisconnected", () => {
          log(`Stick ${key}: disconnected`);
          statusElem.textContent = "disconnected";
          infoElem.textContent = "";
          disconnectBtn.disabled = true;
          connectBtn.disabled = false;
        });

        log(`Stick ${key}: connecting to GATT server...`);
        const server = await device.gatt.connect();
        sticks[key].server = server;

        const service = await server.getPrimaryService(UART_SERVICE_UUID);
        const txChar = await service.getCharacteristic(UART_TX_UUID);
        const rxChar = await service.getCharacteristic(UART_RX_UUID);

        sticks[key].txChar = txChar;
        sticks[key].rxChar = rxChar;

        await rxChar.startNotifications();
        rxChar.addEventListener("characteristicvaluechanged", event => {
          const value = new TextDecoder().decode(event.target.value);
          log(`RX (${key}): ${value.trim()}`);
        });

        statusElem.textContent = "connected";
        infoElem.textContent = device.name ? `Name: ${device.name}` : "Name: (unknown)";
        connectBtn.disabled = true;
        disconnectBtn.disabled = false;

        log(`Stick ${key}: connected`);
      } catch (err) {
        log(`Stick ${key}: ERROR during connect: ${err.message || err}`);
      }
    }

    async function disconnectStick(key) {
      const s = sticks[key];
      if (s.device && s.device.gatt.connected) {
        log(`Stick ${key}: disconnecting...`);
        s.device.gatt.disconnect();
      }
      sticks[key] = { device: null, server: null, txChar: null, rxChar: null };
      document.getElementById(`status${key}`).textContent = "disconnected";
      document.getElementById(`info${key}`).textContent = "";
      document.getElementById(`disconnect${key}`).disabled = true;
      document.getElementById(`connect${key}`).disabled = false;
    }

    // Send a command line to all connected sticks
    async function sendCommand(line) {
      const payload = encoder.encode(line + "\n");
      log(`TX: ${line}`);

      const promises = [];

      for (const key of ["A", "B"]) {
        const tx = sticks[key].txChar;
        if (tx) {
          promises.push(
            tx.writeValueWithoutResponse(payload).catch(err => {
              log(`ERROR TX (${key}): ${err.message || err}`);
            })
          );
        }
      }

      if (promises.length === 0) {
        log("‚ö† No sticks connected; command not sent.");
      } else {
        await Promise.all(promises);
      }
    }

    // === Wire up buttons ===

    // Connection buttons
    document.getElementById("connectA").addEventListener("click", () => connectStick("A"));
    document.getElementById("disconnectA").addEventListener("click", () => disconnectStick("A"));
    document.getElementById("connectB").addEventListener("click", () => connectStick("B"));
    document.getElementById("disconnectB").addEventListener("click", () => disconnectStick("B"));

    // List / pattern navigation
    document.getElementById("nextList").addEventListener("click", () => {
      sendCommand("CMD:NEXT_LIST");
    });
    document.getElementById("prevList").addEventListener("click", () => {
      sendCommand("CMD:PREV_LIST");
    });

    document.getElementById("nextPattern").addEventListener("click", () => {
      sendCommand("CMD:NEXT_PATTERN");
    });
    document.getElementById("prevPattern").addEventListener("click", () => {
      sendCommand("CMD:PREV_PATTERN");
    });

    document.getElementById("favorite").addEventListener("click", () => {
      sendCommand("CMD:FAVORITE");
    });

    // Direct SET:LIST / SET:PATTERN
    document.getElementById("setList").addEventListener("click", () => {
      const n = parseInt(document.getElementById("listIndex").value, 10) || 0;
      sendCommand(`SET:LIST:${n}`);
    });

    document.getElementById("setPattern").addEventListener("click", () => {
      const n = parseInt(document.getElementById("patternIndex").value, 10) || 0;
      sendCommand(`SET:PATTERN:${n}`);
    });

    // Brightness slider (0..7)
    const brightSlider = document.getElementById("brightSlider");
    const brightLabel = document.getElementById("brightLabel");

    brightSlider.addEventListener("input", () => {
      brightLabel.textContent = brightSlider.value;
    });

    document.getElementById("brightSend").addEventListener("click", () => {
      const val = parseInt(brightSlider.value, 10) || 0;
      sendCommand(`SET:BRIGHT:${val}`);
    });

    // Shuffle T slider: 0.5s..10s mapped linearly from 5..100
    const tSlider = document.getElementById("tSlider");
    const tLabel = document.getElementById("tLabel");

    function updateTLabel() {
      const raw = parseInt(tSlider.value, 10);
      const seconds = raw / 10.0;         // 5 -> 0.5s, 100 -> 10.0s
      const ms = Math.round(seconds * 1000);
      tLabel.textContent = `${seconds.toFixed(1)} s (${ms} ms)`;
    }

    tSlider.addEventListener("input", updateTLabel);
    updateTLabel();

    document.getElementById("tSend").addEventListener("click", () => {
      const raw = parseInt(tSlider.value, 10);
      const seconds = raw / 10.0;
      let ms = Math.round(seconds * 1000);
      if (ms < 500) ms = 500; // matches firmware clamp
      sendCommand(`SET:SHUFFLE_T:${ms}`);
    });

    // Flags
    document.getElementById("sendFlags").addEventListener("click", () => {
      const shuffle = document.getElementById("flagShuffle").checked ? 1 : 0;
      const sleep   = document.getElementById("flagSleepTimer").checked ? 1 : 0;
      const lock    = document.getElementById("flagPowerLock").checked ? 1 : 0;

      sendCommand(`SET:BOOL:shuffle:${shuffle}`);
      sendCommand(`SET:BOOL:sleepTimer:${sleep}`);
      sendCommand(`SET:BOOL:powerLock:${lock}`);
    });

    // Special commands
    document.getElementById("goSleep").addEventListener("click", () => {
      sendCommand("CMD:GO_SLEEP");
    });

    document.getElementById("rave").addEventListener("click", () => {
      sendCommand("CMD:RAVE");
    });

    // Raw input
    document.getElementById("rawSend").addEventListener("click", () => {
      const val = document.getElementById("rawInput").value.trim();
      if (val) sendCommand(val);
    });

    document.getElementById("rawInput").addEventListener("keydown", e => {
      if (e.key === "Enter") {
        e.preventDefault();
        document.getElementById("rawSend").click();
      }
    });
  </script>
</body>
</html>
