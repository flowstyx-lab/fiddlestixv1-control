<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FiddleStyx V1 Control</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #111;
      color: #eee;
      margin: 0;
      padding: 16px;
    }

    h1 {
      margin-top: 0;
      font-size: 1.6rem;
    }

    .card {
      background: #181818;
      border-radius: 12px;
      padding: 12px 16px;
      margin-bottom: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.35);
    }

    button {
      background: #0af;
      color: #000;
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 0.95rem;
      cursor: pointer;
      margin-right: 8px;
    }

    button.secondary {
      background: #333;
      color: #eee;
    }

    button:disabled {
      opacity: 0.4;
      cursor: default;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      margin-top: 8px;
    }

    .label {
      font-size: 0.9rem;
      opacity: 0.8;
    }

    input[type="range"] {
      width: 200px;
    }

    .value {
      font-family: "Menlo", "Consolas", monospace;
      margin-left: 4px;
    }

    .list-circle {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 2px solid #444;
      cursor: pointer;
      box-sizing: border-box;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      margin-right: 8px;
    }

    .list-circle.selected {
      border-color: #fff;
      box-shadow: 0 0 0 2px rgba(255,255,255,0.35);
    }

    .list-circle span {
      color: #000;
      font-weight: 700;
    }

    .toggle-label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      font-size: 0.9rem;
    }

    canvas {
      background: #000;
      border-radius: 8px;
      width: 100%;
      max-height: 260px;
    }

    .status-dot {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 6px;
      background: #700;
    }

    .status-dot.connected {
      background: #0f0;
    }

    .status-dot.connecting {
      background: #fa0;
    }

    .small {
      font-size: 0.8rem;
      opacity: 0.7;
    }
  </style>
</head>
<body>
  <h1>FiddleStyx V1 Control</h1>

  <div class="card">
    <div class="row">
      <button id="connectBtn">Connect</button>
      <button id="disconnectBtn" class="secondary" disabled>Disconnect</button>
      <span id="status"><span class="status-dot" id="statusDot"></span>Disconnected</span>
    </div>
    <div class="row small">
      <span>Device name: <strong>FiddleStIXV1</strong></span>
    </div>
    <div class="row small">
      <span>Battery: <span id="batteryText">-- % / --.- V</span></span>
    </div>
  </div>

  <div class="card">
    <h2 style="font-size:1.1rem;margin-top:0;">Pattern Controls</h2>

    <div class="row">
      <span class="label">Brightness (B):</span>
      <input type="range" id="brightnessSlider" min="0" max="7" value="4" />
      <span class="value" id="brightnessValue">B4 (55%)</span>
    </div>

    <div class="row">
      <span class="label">Meta/Disco dwell T (seconds per pattern):</span>
      <input type="range" id="tSlider" min="1" max="120" value="12" />
      <span class="value" id="tValue">12 s</span>
    </div>

    <div class="row">
      <span class="label">List:</span>
      <div id="listSelector">
        <!-- W -->
        <div class="list-circle selected" data-list="0" style="background:#ffffff;color:#000;">
          <span>W</span>
        </div>
        <!-- R -->
        <div class="list-circle" data-list="1" style="background:#ff0000;color:#000;">
          <span>R</span>
        </div>
        <!-- O -->
        <div class="list-circle" data-list="2" style="background:#ff7f00;color:#000;">
          <span>O</span>
        </div>
        <!-- Y -->
        <div class="list-circle" data-list="3" style="background:#ffff00;color:#000;">
          <span>Y</span>
        </div>
        <!-- G -->
        <div class="list-circle" data-list="4" style="background:#00ff00;color:#000;">
          <span>G</span>
        </div>
        <!-- B -->
        <div class="list-circle" data-list="5" style="background:#007fff;color:#000;">
          <span>B</span>
        </div>
        <!-- I -->
        <div class="list-circle" data-list="6" style="background:#4b0082;color:#fff;">
          <span>I</span>
        </div>
        <!-- V -->
        <div class="list-circle" data-list="7" style="background:#9400d3;color:#fff;">
          <span>V</span>
        </div>
        <!-- Blacklist -->
        <div class="list-circle" data-list="8" style="background:#000000;color:#fff;">
          <span>Bl</span>
        </div>
      </div>
    </div>

    <div class="row">
      <span class="label">Pattern index (0 = meta):</span>
      <input type="range" id="patternSlider" min="0" max="100" value="0" />
      <span class="value" id="patternValue">0 (meta)</span>
    </div>

    <div class="row">
      <label class="toggle-label">
        <input type="checkbox" id="sleepToggle" checked />
        Sleep enabled
      </label>
      <button id="favoriteBtn" class="secondary">Favorite (add to White #1)</button>
    </div>

    <div class="row small">
      <span>TIP: Use <code>D1</code> / <code>D0</code> to enter/exit DISCO from the Console or GUI if you add that later.</span>
    </div>
  </div>

  <div class="card">
    <h2 style="font-size:1.1rem;margin-top:0;">IMU (Accel) Data</h2>
    <p class="small">X, Y, Z axes and |g|, streamed from the LSM6DS3.</p>
    <canvas id="imuChart"></canvas>
  </div>

  <div class="card">
    <h2 style="font-size:1.1rem;margin-top:0;">Mic Level</h2>
    <p class="small">RMS amplitude from PDM mic (0â€“1 range).</p>
    <canvas id="micChart"></canvas>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <script>
    // Nordic UART Service UUIDs
    const NUS_SERVICE_UUID = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
    const NUS_TX_UUID      = '6e400003-b5a3-f393-e0a9-e50e24dcca9e'; // notifications from device -> browser
    const NUS_RX_UUID      = '6e400002-b5a3-f393-e0a9-e50e24dcca9e'; // writes from browser -> device

    let bleDevice = null;
    let gattServer = null;
    let txChar = null;  // notify characteristic
    let rxChar = null;  // write characteristic

    const connectBtn    = document.getElementById('connectBtn');
    const disconnectBtn = document.getElementById('disconnectBtn');
    const statusSpan    = document.getElementById('status');
    const statusDot     = document.getElementById('statusDot');
    const batteryText   = document.getElementById('batteryText');

    const brightnessSlider = document.getElementById('brightnessSlider');
    const brightnessValue  = document.getElementById('brightnessValue');
    const tSlider          = document.getElementById('tSlider');
    const tValue           = document.getElementById('tValue');
    const patternSlider    = document.getElementById('patternSlider');
    const patternValue     = document.getElementById('patternValue');
    const sleepToggle      = document.getElementById('sleepToggle');
    const favoriteBtn      = document.getElementById('favoriteBtn');
    const listSelector     = document.getElementById('listSelector');

    // ------------------------------
    // Chart setup
    // ------------------------------
    const imuCtx = document.getElementById('imuChart').getContext('2d');
    const micCtx = document.getElementById('micChart').getContext('2d');

    const MAX_POINTS = 300;
    let sampleIndex = 0;

    const imuData = {
      labels: [],
      datasets: [
        {
          label: 'ax (g)',
          data: [],
          borderWidth: 1,
          tension: 0.2
        },
        {
          label: 'ay (g)',
          data: [],
          borderWidth: 1,
          tension: 0.2
        },
        {
          label: 'az (g)',
          data: [],
          borderWidth: 1,
          tension: 0.2
        },
        {
          label: '|g|',
          data: [],
          borderWidth: 1,
          tension: 0.2
        }
      ]
    };

    const micData = {
      labels: [],
      datasets: [
        {
          label: 'Mic level',
          data: [],
          borderWidth: 1,
          tension: 0.2
        }
      ]
    };

    const imuChart = new Chart(imuCtx, {
      type: 'line',
      data: imuData,
      options: {
        animation: false,
        responsive: true,
        scales: {
          x: { display: false },
          y: {
            display: true,
            suggestedMin: -2,
            suggestedMax:  2
          }
        },
        plugins: {
          legend: {
            labels: { color: '#eee' }
          }
        }
      }
    });

    const micChart = new Chart(micCtx, {
      type: 'line',
      data: micData,
      options: {
        animation: false,
        responsive: true,
        scales: {
          x: { display: false },
          y: {
            display: true,
            suggestedMin: 0,
            suggestedMax: 1
          }
        },
        plugins: {
          legend: {
            labels: { color: '#eee' }
          }
        }
      }
    });

    function addImuPoint(ax, ay, az, g) {
      sampleIndex++;
      imuData.labels.push(sampleIndex);
      imuData.datasets[0].data.push(ax);
      imuData.datasets[1].data.push(ay);
      imuData.datasets[2].data.push(az);
      imuData.datasets[3].data.push(g);

      if (imuData.labels.length > MAX_POINTS) {
        imuData.labels.shift();
        imuData.datasets.forEach(ds => ds.data.shift());
      }

      imuChart.update('none');
    }

    function addMicPoint(level) {
      sampleIndex++;
      micData.labels.push(sampleIndex);
      micData.datasets[0].data.push(level);

      if (micData.labels.length > MAX_POINTS) {
        micData.labels.shift();
        micData.datasets[0].data.shift();
      }

      micChart.update('none');
    }

    // ------------------------------
    // UI helpers
    // ------------------------------
    function setStatus(text, state) {
      statusSpan.innerHTML = '';
      const dot = document.createElement('span');
      dot.className = 'status-dot';
      if (state === 'connected') dot.classList.add('connected');
      if (state === 'connecting') dot.classList.add('connecting');
      statusSpan.appendChild(dot);
      statusSpan.appendChild(document.createTextNode(text));
      statusDot.className = dot.className;
    }

    function mapBrightnessToPercent(b) {
      if (b === 0) return 0;
      const percent = 10 + (b - 1) * (90 / 6);
      return Math.round(percent);
    }

    function updateBrightnessLabel() {
      const b = parseInt(brightnessSlider.value, 10);
      const pct = mapBrightnessToPercent(b);
      if (b === 0) {
        brightnessValue.textContent = 'B0 (off)';
      } else {
        brightnessValue.textContent = `B${b} (${pct}%)`;
      }
    }

    function updateTLabel() {
      const t = parseInt(tSlider.value, 10);
      tValue.textContent = `${t} s`;
    }

    function updatePatternLabel() {
      const idx = parseInt(patternSlider.value, 10);
      if (idx === 0) {
        patternValue.textContent = '0 (meta)';
      } else {
        patternValue.textContent = idx.toString();
      }
    }

    updateBrightnessLabel();
    updateTLabel();
    updatePatternLabel();

    // ------------------------------
    // BLE helpers
    // ------------------------------
    function sendCommand(str) {
      if (!rxChar) return;
      const enc = new TextEncoder();
      const data = enc.encode(str + '\n');
      rxChar.writeValue(data).catch(err => {
        console.error('Write error:', err);
      });
    }

    async function connect() {
      try {
        setStatus('Requesting device...', 'connecting');
        bleDevice = await navigator.bluetooth.requestDevice({
          filters: [{ namePrefix: 'FiddleStIXV1' }],
          optionalServices: [NUS_SERVICE_UUID]
        });

        bleDevice.addEventListener('gattserverdisconnected', onDisconnected);

        setStatus('Connecting GATT...', 'connecting');
        gattServer = await bleDevice.gatt.connect();

        const service = await gattServer.getPrimaryService(NUS_SERVICE_UUID);
        txChar = await service.getCharacteristic(NUS_TX_UUID);
        rxChar = await service.getCharacteristic(NUS_RX_UUID);

        await txChar.startNotifications();
        txChar.addEventListener('characteristicvaluechanged', handleUartNotification);

        connectBtn.disabled = true;
        disconnectBtn.disabled = false;
        setStatus('Connected', 'connected');

        // Sync initial settings
        sendCommand('B' + brightnessSlider.value);
        sendCommand('T' + tSlider.value);
        sendCommand('L0');
        sendCommand('I0');
        sendCommand(sleepToggle.checked ? 'S1' : 'S0');
      } catch (err) {
        console.error('BLE connect error:', err);
        setStatus('Disconnected (error)', 'disconnected');
        connectBtn.disabled = false;
        disconnectBtn.disabled = true;
      }
    }

    function onDisconnected() {
      console.log('Device disconnected');
      txChar = null;
      rxChar = null;
      connectBtn.disabled = false;
      disconnectBtn.disabled = true;
      setStatus('Disconnected', 'disconnected');
    }

    async function disconnect() {
      if (!bleDevice) return;
      try {
        if (bleDevice.gatt.connected) {
          await bleDevice.gatt.disconnect();
        }
      } catch (err) {
        console.error('Error on disconnect:', err);
      }
    }

    // ------------------------------
    // Uart notifications / parsing
    // ------------------------------
    const decoder = new TextDecoder('utf-8');
    let rxBuffer = '';

    function handleUartNotification(event) {
      const value = event.target.value;
      rxBuffer += decoder.decode(value, { stream: true });

      let idx;
      while ((idx = rxBuffer.indexOf('\n')) >= 0) {
        const line = rxBuffer.slice(0, idx).trim();
        rxBuffer = rxBuffer.slice(idx + 1);
        if (line.length > 0) {
          handleTelemetryLine(line);
        }
      }
    }

    function handleTelemetryLine(line) {
      // Expect:
      //  IMU,ax,ay,az,g
      //  MIC,level
      //  BAT,percent,voltage
      const parts = line.split(',');
      if (parts.length === 0) return;

      const tag = parts[0];
      if (tag === 'IMU' && parts.length >= 5) {
        const ax = parseFloat(parts[1]);
        const ay = parseFloat(parts[2]);
        const az = parseFloat(parts[3]);
        const g  = parseFloat(parts[4]);
        if (!isNaN(ax) && !isNaN(ay) && !isNaN(az) && !isNaN(g)) {
          addImuPoint(ax, ay, az, g);
        }
      } else if (tag === 'MIC' && parts.length >= 2) {
        const level = parseFloat(parts[1]);
        if (!isNaN(level)) {
          addMicPoint(level);
        }
      } else if (tag === 'BAT' && parts.length >= 3) {
        const pct = parseInt(parts[1], 10);
        const volt = parseFloat(parts[2]);
        if (!isNaN(pct) && !isNaN(volt)) {
          batteryText.textContent = `${pct} % / ${volt.toFixed(2)} V`;
        }
      } else {
        // debug line or unknown tag; ignore
        // console.log('Unknown line:', line);
      }
    }

    // ------------------------------
    // UI event wiring
    // ------------------------------
    connectBtn.addEventListener('click', () => {
      if (!navigator.bluetooth) {
        alert('Web Bluetooth is not available in this browser.');
        return;
      }
      connect();
    });

    disconnectBtn.addEventListener('click', () => {
      disconnect();
    });

    brightnessSlider.addEventListener('input', () => {
      updateBrightnessLabel();
    });

    brightnessSlider.addEventListener('change', () => {
      updateBrightnessLabel();
      sendCommand('B' + brightnessSlider.value);
    });

    tSlider.addEventListener('input', () => {
      updateTLabel();
    });

    tSlider.addEventListener('change', () => {
      updateTLabel();
      sendCommand('T' + tSlider.value);
    });

    patternSlider.addEventListener('input', () => {
      updatePatternLabel();
    });

    patternSlider.addEventListener('change', () => {
      updatePatternLabel();
      sendCommand('I' + patternSlider.value);
    });

    sleepToggle.addEventListener('change', () => {
      sendCommand(sleepToggle.checked ? 'S1' : 'S0');
    });

    favoriteBtn.addEventListener('click', () => {
      sendCommand('F');
    });

    listSelector.addEventListener('click', (ev) => {
      const target = ev.target.closest('.list-circle');
      if (!target) return;
      const idx = parseInt(target.dataset.list, 10);
      if (isNaN(idx)) return;

      document.querySelectorAll('.list-circle').forEach(el => {
        el.classList.toggle('selected', el === target);
      });

      sendCommand('L' + idx);
    });

    // Initial status
    setStatus('Disconnected', 'disconnected');
  </script>
</body>
</html>
