<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>FiddleStix V1 Control</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Chart.js for graphs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #050510;
      --panel: #111325;
      --accent: #ff4dd2;
      --accent2: #18f0ff;
      --text: #f5f7ff;
      --muted: #8890b0;
      --radius: 16px;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background: radial-gradient(circle at top, #31154d 0, #050510 45%, #000 100%);
      color: var(--text);
      display: flex;
      justify-content: center;
    }

    .app {
      max-width: 1080px;
      width: 100%;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .title-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    h1 {
      font-size: 1.6rem;
      margin: 0;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    h1 span.logo-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: conic-gradient(from 120deg, #fff, #ff4dd2, #18f0ff, #fff);
      box-shadow: 0 0 16px rgba(255, 77, 210, 0.9);
    }

    .pill {
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(10, 12, 32, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.06);
      font-size: 0.78rem;
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .pill-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #ff4dd2;
      box-shadow: 0 0 10px rgba(255, 77, 210, 0.8);
    }

    .grid {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
      gap: 16px;
    }

    .card {
      background: radial-gradient(circle at top left, rgba(255, 255, 255, 0.04), transparent 55%),
                  var(--panel);
      border-radius: var(--radius);
      border: 1px solid rgba(255, 255, 255, 0.06);
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.45);
      padding: 14px 16px 16px;
      backdrop-filter: blur(14px);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .card-header h2 {
      margin: 0;
      font-size: 0.95rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--muted);
    }

    .card-header small {
      font-size: 0.75rem;
      color: var(--muted);
    }

    button,
    .toggle {
      border: none;
      outline: none;
      cursor: pointer;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 0.85rem;
      background: linear-gradient(135deg, #ff4dd2, #ffb347);
      color: #050510;
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      box-shadow: 0 8px 22px rgba(255, 77, 210, 0.6);
      transition: transform 0.12s ease, box-shadow 0.12s ease, filter 0.12s ease;
    }

    button:active,
    .toggle:active {
      transform: translateY(1px) scale(0.98);
      box-shadow: 0 3px 12px rgba(255, 77, 210, 0.7);
      filter: brightness(0.94);
    }

    button.secondary {
      background: linear-gradient(135deg, #1b224a, #262f66);
      color: var(--text);
      box-shadow: 0 8px 22px rgba(0, 0, 0, 0.6);
    }

    button.secondary.active {
      background: linear-gradient(135deg, #18f0ff, #4df1ff);
      color: #050510;
      box-shadow: 0 8px 22px rgba(24, 240, 255, 0.7);
    }

    .row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .row.space {
      justify-content: space-between;
    }

    .label {
      font-size: 0.8rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.13em;
    }

    .value {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--accent2);
    }

    .slider-group {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    input[type="range"] {
      width: 100%;
      -webkit-appearance: none;
      height: 5px;
      border-radius: 999px;
      background: #1f2344;
      outline: none;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #fff, #ff4dd2);
      box-shadow: 0 0 10px rgba(255, 77, 210, 0.9);
      cursor: pointer;
    }

    input[type="range"]::-moz-range-thumb {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #fff, #ff4dd2);
      box-shadow: 0 0 10px rgba(255, 77, 210, 0.9);
      cursor: pointer;
    }

    .list-picker {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 6px;
    }

    .list-circle {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      border: 2px solid rgba(255, 255, 255, 0.3);
      cursor: pointer;
      box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.0);
      transition: transform 0.12s ease, box-shadow 0.12s ease, border 0.12s ease, filter 0.12s ease;
      position: relative;
    }

    .list-circle.active {
      transform: scale(1.08);
      border-color: #fff;
      box-shadow: 0 0 12px rgba(255, 255, 255, 0.5);
    }

    .list-circle span {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 0.7rem;
      color: #fff;
      text-shadow: 0 0 4px rgba(0, 0, 0, 0.7);
    }

    .toggle-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 6px;
    }

    .toggle-switch {
      position: relative;
      width: 42px;
      height: 22px;
      border-radius: 999px;
      background: #252a4b;
      cursor: pointer;
      transition: background 0.15s ease;
    }

    .toggle-switch::before {
      content: "";
      position: absolute;
      top: 3px;
      left: 4px;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #aab0d8;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.6);
      transition: transform 0.15s ease, background 0.15s ease;
    }

    .toggle-switch.on {
      background: linear-gradient(135deg, #18f0ff, #4df1ff);
    }

    .toggle-switch.on::before {
      transform: translateX(16px);
      background: #050510;
    }

    .graph-container {
      height: 180px;
      margin-top: 4px;
      border-radius: 14px;
      background: radial-gradient(circle at top, rgba(255, 255, 255, 0.03), transparent 55%);
      border: 1px solid rgba(255, 255, 255, 0.05);
      padding: 6px;
    }

    canvas {
      width: 100% !important;
      height: 100% !important;
    }

    .footer {
      margin-top: 10px;
      font-size: 0.75rem;
      color: var(--muted);
      text-align: right;
      opacity: 0.8;
    }

    .battery-pill {
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(16, 21, 52, 0.85);
      border: 1px solid rgba(255, 255, 255, 0.08);
      font-size: 0.8rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .battery-bar {
      width: 40px;
      height: 8px;
      border-radius: 999px;
      background: #1b2145;
      overflow: hidden;
      position: relative;
    }

    .battery-fill {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 50%;
      border-radius: 999px;
      background: linear-gradient(90deg, #22ff88, #d4ff43);
      box-shadow: 0 0 8px rgba(34, 255, 136, 0.8);
    }

    .badge {
      font-size: 0.7rem;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.16em;
    }

  </style>
</head>
<body>
<div class="app">
  <div class="title-row">
    <h1><span class="logo-dot"></span>FiddleStix V1</h1>
    <div class="pill">
      <div class="pill-dot" id="status-dot"></div>
      <span id="status-label">Disconnected</span>
    </div>
  </div>

  <div class="grid">
    <!-- LEFT: controls -->
    <div class="card">
      <div class="card-header">
        <h2>Connection & Mode</h2>
        <div class="row">
          <span class="badge" id="device-name-label">FiddleStIXV1</span>
        </div>
      </div>

      <div class="row space">
        <div class="row">
          <button id="connect-btn">Connect</button>
          <button id="disconnect-btn" class="secondary">Disconnect</button>
        </div>
        <div class="battery-pill">
          <span>Battery</span>
          <div class="battery-bar">
            <div class="battery-fill" id="battery-fill"></div>
          </div>
          <span id="battery-label">--%</span>
        </div>
      </div>

      <div class="row space" style="margin-top: 12px;">
        <div class="row">
          <button id="disco-btn" class="secondary">Disco</button>
        </div>
        <div class="row">
          <button id="favorite-btn">Favorite</button>
        </div>
      </div>

      <hr style="margin: 12px 0; border-color: rgba(255,255,255,0.06);">

      <div class="card-header">
        <h2>Pattern Space</h2>
        <small>W · R · O · Y · G · B · I · V · Blacklist</small>
      </div>

      <!-- List picker -->
      <div class="list-picker" id="list-picker">
        <!-- White -->
        <div class="list-circle" data-list="0" style="background: radial-gradient(circle, #ffffff 0, #cfd2ff 60%, #8c90ff 100%);">
          <span>W</span>
        </div>
        <!-- Red -->
        <div class="list-circle" data-list="1" style="background: radial-gradient(circle, #ff3b3b, #b11414);">
          <span>R</span>
        </div>
        <!-- Orange -->
        <div class="list-circle" data-list="2" style="background: radial-gradient(circle, #ffb347, #ff7e2a);">
          <span>O</span>
        </div>
        <!-- Yellow -->
        <div class="list-circle" data-list="3" style="background: radial-gradient(circle, #ffe65c, #ffb347);">
          <span>Y</span>
        </div>
        <!-- Green -->
        <div class="list-circle" data-list="4" style="background: radial-gradient(circle, #2ae676, #0db95a);">
          <span>G</span>
        </div>
        <!-- Blue -->
        <div class="list-circle" data-list="5" style="background: radial-gradient(circle, #40b5ff, #1465ff);">
          <span>B</span>
        </div>
        <!-- Indigo -->
        <div class="list-circle" data-list="6" style="background: radial-gradient(circle, #6a5bff, #3122a8);">
          <span>I</span>
        </div>
        <!-- Violet -->
        <div class="list-circle" data-list="7" style="background: radial-gradient(circle, #c94dff, #6717b7);">
          <span>V</span>
        </div>
        <!-- Blacklist -->
        <div class="list-circle" data-list="8" style="background: radial-gradient(circle, #444, #050505);">
          <span>Bl</span>
        </div>
      </div>

      <!-- Sliders -->
      <div class="slider-group">
        <div class="row space">
          <span class="label">Pattern</span>
          <span class="value" id="pattern-value">0</span>
        </div>
        <input type="range" id="pattern-slider" min="0" max="100" value="0">
      </div>

      <div class="slider-group">
        <div class="row space">
          <span class="label">Brightness (B)</span>
          <span class="value" id="brightness-value">4</span>
        </div>
        <input type="range" id="brightness-slider" min="0" max="7" value="4">
      </div>

      <div class="slider-group">
        <div class="row space">
          <span class="label">Meta / Disco T (s)</span>
          <span class="value" id="t-value">12</span>
        </div>
        <input type="range" id="t-slider" min="1" max="120" value="12">
      </div>

      <!-- Toggles -->
      <div class="toggle-row">
        <div class="label">Sleep</div>
        <div class="toggle-switch" id="sleep-toggle"></div>
      </div>
    </div>

    <!-- RIGHT: graphs -->
    <div class="card">
      <div class="card-header">
        <h2>IMU</h2>
        <small>Live accelerometer (X, Y, Z)</small>
      </div>
      <div class="graph-container">
        <canvas id="imu-chart"></canvas>
      </div>

      <div class="card-header" style="margin-top: 12px;">
        <h2>Mic</h2>
        <small>Sound level</small>
      </div>
      <div class="graph-container">
        <canvas id="mic-chart"></canvas>
      </div>
    </div>
  </div>

  <div class="footer">
    Web Bluetooth interface for <strong>FiddleStIXV1</strong> · Move fast, follow the light.
  </div>
</div>

<script>
  // BLE UUIDs for Nordic UART (NUS)
  const NUS_SERVICE_UUID  = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
  const NUS_RX_CHAR_UUID  = '6e400003-b5a3-f393-e0a9-e50e24dcca9e'; // notify from device
  const NUS_TX_CHAR_UUID  = '6e400002-b5a3-f393-e0a9-e50e24dcca9e'; // write to device

  let device = null;
  let server = null;
  let nusService = null;
  let rxChar = null;
  let txChar = null;

  let rxBuffer = '';
  let connected = false;

  // UI elements
  const statusDot      = document.getElementById('status-dot');
  const statusLabel    = document.getElementById('status-label');
  const connectBtn     = document.getElementById('connect-btn');
  const disconnectBtn  = document.getElementById('disconnect-btn');
  const discoBtn       = document.getElementById('disco-btn');
  const favoriteBtn    = document.getElementById('favorite-btn');
  const patternSlider  = document.getElementById('pattern-slider');
  const patternValue   = document.getElementById('pattern-value');
  const brightnessSlider = document.getElementById('brightness-slider');
  const brightnessValue  = document.getElementById('brightness-value');
  const tSlider        = document.getElementById('t-slider');
  const tValue         = document.getElementById('t-value');
  const listPicker     = document.getElementById('list-picker');
  const sleepToggle    = document.getElementById('sleep-toggle');
  const batteryLabel   = document.getElementById('battery-label');
  const batteryFill    = document.getElementById('battery-fill');

  let currentList = 0;
  let discoOn     = false;
  let sleepOn     = true;

  function updateConnectionUI(isConnected) {
    connected = isConnected;
    if (isConnected) {
      statusDot.style.background = '#22ff88';
      statusDot.style.boxShadow  = '0 0 14px rgba(34,255,136,0.9)';
      statusLabel.textContent    = 'Connected';
      connectBtn.disabled        = true;
      disconnectBtn.disabled     = false;
    } else {
      statusDot.style.background = '#ff4dd2';
      statusDot.style.boxShadow  = '0 0 14px rgba(255,77,210,0.9)';
      statusLabel.textContent    = 'Disconnected';
      connectBtn.disabled        = false;
      disconnectBtn.disabled     = true;
      discoOn = false;
      discoBtn.classList.remove('active');
    }
  }

  async function connect() {
    try {
      device = await navigator.bluetooth.requestDevice({
        filters: [{ name: 'FiddleStIXV1' }],
        optionalServices: [NUS_SERVICE_UUID]
      });

      device.addEventListener('gattserverdisconnected', onDisconnected);

      server = await device.gatt.connect();
      nusService = await server.getPrimaryService(NUS_SERVICE_UUID);

      rxChar = await nusService.getCharacteristic(NUS_RX_CHAR_UUID);
      txChar = await nusService.getCharacteristic(NUS_TX_CHAR_UUID);

      await rxChar.startNotifications();
      rxChar.addEventListener('characteristicvaluechanged', handleNotifications);

      updateConnectionUI(true);
    } catch (error) {
      console.error('BLE connect error:', error);
      updateConnectionUI(false);
    }
  }

  function onDisconnected() {
    updateConnectionUI(false);
  }

  async function disconnect() {
    if (device && device.gatt.connected) {
      device.gatt.disconnect();
    }
  }

  async function sendCommand(cmd) {
    if (!connected || !txChar) return;
    try {
      const data = new TextEncoder().encode(cmd + '\n');
      await txChar.writeValue(data);
    } catch (err) {
      console.error('sendCommand error', err);
    }
  }

  function handleNotifications(event) {
    const value = event.target.value;
    const text = new TextDecoder().decode(value);
    rxBuffer += text;

    let idx;
    while ((idx = rxBuffer.indexOf('\n')) >= 0) {
      const line = rxBuffer.slice(0, idx).trim();
      rxBuffer = rxBuffer.slice(idx + 1);
      if (line.length > 0) {
        processLine(line);
      }
    }
  }

  // -------------------------------------------------------------------------
  // Charts
  // -------------------------------------------------------------------------
  const imuCtx = document.getElementById('imu-chart').getContext('2d');
  const micCtx = document.getElementById('mic-chart').getContext('2d');

  const imuData = {
    labels: [],
    datasets: [
      { label: 'X', data: [], borderColor: '#ff4dd2', borderWidth: 1.5, pointRadius: 0 },
      { label: 'Y', data: [], borderColor: '#18f0ff', borderWidth: 1.5, pointRadius: 0 },
      { label: 'Z', data: [], borderColor: '#ffe65c', borderWidth: 1.5, pointRadius: 0 }
    ]
  };

  const imuChart = new Chart(imuCtx, {
    type: 'line',
    data: imuData,
    options: {
      responsive: true,
      animation: false,
      plugins: { legend: { display: true, labels: { color: '#d1d4ff', boxWidth: 10 } } },
      scales: {
        x: {
          display: false
        },
        y: {
          ticks: { color: '#a3a7d8', maxTicksLimit: 5 },
          grid: { color: 'rgba(255,255,255,0.04)' },
          suggestedMin: -2,
          suggestedMax: 2
        }
      }
    }
  });

  const micData = {
    labels: [],
    datasets: [
      { label: 'Level', data: [], borderColor: '#4df1ff', borderWidth: 1.5, pointRadius: 0 }
    ]
  };

  const micChart = new Chart(micCtx, {
    type: 'line',
    data: micData,
    options: {
      responsive: true,
      animation: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { display: false },
        y: {
          ticks: { color: '#a3a7d8', maxTicksLimit: 5 },
          grid: { color: 'rgba(255,255,255,0.04)' },
          suggestedMin: 0,
          suggestedMax: 1
        }
      }
    }
  });

  const MAX_POINTS = 200;
  let sampleIndex = 0;

  function processLine(line) {
    // Example lines:
    // IMU,ax,ay,az,g
    // MIC,level
    // BAT,pct,volt
    // CFG,B,b,T,t
    const parts = line.split(',');
    if (parts[0] === 'IMU' && parts.length >= 5) {
      const ax = parseFloat(parts[1]);
      const ay = parseFloat(parts[2]);
      const az = parseFloat(parts[3]);

      imuData.labels.push(sampleIndex);
      imuData.datasets[0].data.push(ax);
      imuData.datasets[1].data.push(ay);
      imuData.datasets[2].data.push(az);

      if (imuData.labels.length > MAX_POINTS) {
        imuData.labels.shift();
        imuData.datasets.forEach(d => d.data.shift());
      }
      sampleIndex++;
      imuChart.update('none');
    } else if (parts[0] === 'MIC' && parts.length >= 2) {
      const lvl = parseFloat(parts[1]);
      micData.labels.push(sampleIndex);
      micData.datasets[0].data.push(lvl);
      if (micData.labels.length > MAX_POINTS) {
        micData.labels.shift();
        micData.datasets[0].data.shift();
      }
      micChart.update('none');
    } else if (parts[0] === 'BAT' && parts.length >= 3) {
      const pct = parseInt(parts[1], 10);
      batteryLabel.textContent = isNaN(pct) ? '--%' : pct + '%';
      const width = isNaN(pct) ? 0 : Math.max(0, Math.min(100, pct));
      batteryFill.style.width = width + '%';
      if (pct < 25) {
        batteryFill.style.background = 'linear-gradient(90deg,#ff4d4d,#ffb347)';
      } else if (pct < 50) {
        batteryFill.style.background = 'linear-gradient(90deg,#ffb347,#ffe65c)';
      } else {
        batteryFill.style.background = 'linear-gradient(90deg,#22ff88,#d4ff43)';
      }
    } else if (parts[0] === 'CFG' && parts.length >= 5) {
      // CFG,B,b,T,t
      const b = parseInt(parts[2], 10);
      const t = parseInt(parts[4], 10);
      if (!isNaN(b)) {
        brightnessSlider.value = b;
        brightnessValue.textContent = b;
      }
      if (!isNaN(t)) {
        tSlider.value = t;
        tValue.textContent = t;
      }
    }
  }

  // -------------------------------------------------------------------------
  // UI wiring
  // -------------------------------------------------------------------------
  connectBtn.addEventListener('click', () => {
    if (!navigator.bluetooth) {
      alert('Web Bluetooth not supported in this browser.');
      return;
    }
    connect();
  });

  disconnectBtn.addEventListener('click', () => {
    disconnect();
  });

  // List circles
  function setActiveListCircle(index) {
    document.querySelectorAll('.list-circle').forEach(el => {
      if (parseInt(el.dataset.list, 10) === index) el.classList.add('active');
      else el.classList.remove('active');
    });
  }

  listPicker.addEventListener('click', (e) => {
    const target = e.target.closest('.list-circle');
    if (!target) return;
    const listIdx = parseInt(target.dataset.list, 10);
    currentList = listIdx;
    setActiveListCircle(currentList);
    sendCommand('L' + listIdx);
  });

  // Initial active list
  setActiveListCircle(0);

  // Pattern slider
  patternSlider.addEventListener('input', () => {
    patternValue.textContent = patternSlider.value;
  });
  patternSlider.addEventListener('change', () => {
    sendCommand('I' + patternSlider.value);
  });

  // Brightness slider
  brightnessSlider.addEventListener('input', () => {
    brightnessValue.textContent = brightnessSlider.value;
  });
  brightnessSlider.addEventListener('change', () => {
    sendCommand('B' + brightnessSlider.value);
  });

  // T slider
  tSlider.addEventListener('input', () => {
    tValue.textContent = tSlider.value;
  });
  tSlider.addEventListener('change', () => {
    sendCommand('T' + tSlider.value);
  });

  // Sleep toggle
  sleepToggle.addEventListener('click', () => {
    sleepOn = !sleepOn;
    sleepToggle.classList.toggle('on', sleepOn);
    sendCommand(sleepOn ? 'S1' : 'S0');
  });
  // default ON
  sleepOn = true;
  sleepToggle.classList.add('on');

  // Disco button
  discoBtn.addEventListener('click', () => {
    discoOn = !discoOn;
    discoBtn.classList.toggle('active', discoOn);
    sendCommand(discoOn ? 'D1' : 'D0');
  });

  // Favorite button
  favoriteBtn.addEventListener('click', () => {
    sendCommand('FAV');
    favoriteBtn.style.filter = 'brightness(1.2)';
    setTimeout(() => { favoriteBtn.style.filter = ''; }, 130);
  });
</script>
</body>
</html>
