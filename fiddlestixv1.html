<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FiddleStIXV1 Control</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #050609;
      color: #f9fafb;
      margin: 0;
      padding: 16px;
    }
    h1 {
      margin-top: 0;
      font-size: 1.4rem;
    }
    .card {
      background: #111827;
      border-radius: 12px;
      padding: 12px 16px;
      margin-bottom: 12px;
      box-shadow: 0 4px 14px rgba(0,0,0,0.4);
    }
    button {
      padding: 6px 12px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      margin: 2px;
      font-size: 0.9rem;
      background: #2563eb;
      color: white;
    }
    button.secondary {
      background: #4b5563;
    }
    button.danger {
      background: #b91c1c;
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    .row > * {
      margin-right: 4px;
    }
    .slider-group {
      margin: 4px 0;
    }
    .slider-label {
      font-size: 0.85rem;
      opacity: 0.85;
    }
    input[type="range"] {
      width: 180px;
    }
    .list-circles {
      display: flex;
      gap: 8px;
      margin-top: 4px;
      flex-wrap: wrap;
    }
    .list-circle {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      border: 2px solid transparent;
      cursor: pointer;
      box-shadow: 0 0 8px rgba(0,0,0,0.6);
    }
    .list-circle.selected {
      border-color: #f9fafb;
      box-shadow: 0 0 10px rgba(249,250,251,0.9);
    }
    .toggle-group {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 4px;
    }
    .small-label {
      font-size: 0.8rem;
      opacity: 0.8;
    }
    canvas {
      background: #020617;
      border-radius: 8px;
      padding: 4px;
    }
    .battery-display {
      font-size: 0.9rem;
      margin-top: 4px;
    }
    .current-pattern {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 8px;
    }
    .current-circle {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1rem;
      color: #000000;          /* black text as requested */
      border: 2px solid #e5e7eb;
      box-shadow: 0 0 12px rgba(0,0,0,0.7);
    }
    .current-pattern-text {
      font-size: 0.9rem;
      opacity: 0.9;
    }
  </style>

  <!-- Chart.js from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
  <h1>FiddleStIXV1 Control</h1>

  <div class="card">
    <div class="row">
      <button id="connectBtn">Connect</button>
      <span id="status" class="small-label">Not connected</span>
    </div>
    <div class="row" style="margin-top:4px;">
      <button id="onBtn"      class="secondary" disabled>ON</button>
      <button id="offBtn"     class="secondary" disabled>OFF</button>
      <button id="discoOnBtn" class="secondary" disabled>DISCO ON</button>
      <button id="discoOffBtn"class="secondary" disabled>DISCO OFF</button>
      <button id="favBtn"                 disabled>Favorite</button>
    </div>
  </div>

  <div class="card">
    <div class="slider-group">
      <div class="slider-label">
        Brightness (B): <span id="bVal">4</span> (0 = off, 1–7 = 10–100%)
      </div>
      <input type="range" id="bSlider" min="0" max="7" value="4" />
    </div>

    <div class="slider-group">
      <div class="slider-label">
        Meta T (seconds per pattern in meta): <span id="tVal">12</span> s
      </div>
      <input type="range" id="tSlider" min="1" max="120" value="12" />
    </div>

    <div class="slider-group">
      <div class="slider-label">
        Pattern index (I): <span id="iVal">0</span> (0 = meta, 1–100 = patterns)
      </div>
      <input type="range" id="iSlider" min="0" max="100" value="0" />
    </div>

    <div style="margin-top:6px;">
      <div class="slider-label">List selection (L0..L7)</div>
      <div class="list-circles" id="listCircles">
        <!-- 0: White -->
        <div class="list-circle selected" data-list="0"
          style="background: radial-gradient(circle at 30% 30%, #ffffff, #d1d5db);"></div>
        <!-- 1: Red -->
        <div class="list-circle" data-list="1"
          style="background: radial-gradient(circle at 30% 30%, #f97373, #b91c1c);"></div>
        <!-- 2: Orange -->
        <div class="list-circle" data-list="2"
          style="background: radial-gradient(circle at 30% 30%, #fed7aa, #ea580c);"></div>
        <!-- 3: Yellow -->
        <div class="list-circle" data-list="3"
          style="background: radial-gradient(circle at 30% 30%, #fef9c3, #eab308);"></div>
        <!-- 4: Green -->
        <div class="list-circle" data-list="4"
          style="background: radial-gradient(circle at 30% 30%, #bbf7d0, #16a34a);"></div>
        <!-- 5: Blue -->
        <div class="list-circle" data-list="5"
          style="background: radial-gradient(circle at 30% 30%, #bfdbfe, #2563eb);"></div>
        <!-- 6: Indigo -->
        <div class="list-circle" data-list="6"
          style="background: radial-gradient(circle at 30% 30%, #c7d2fe, #4f46e5);"></div>
        <!-- 7: Violet -->
        <div class="list-circle" data-list="7"
          style="background: radial-gradient(circle at 30% 30%, #f5d0fe, #a855f7);"></div>
      </div>
    </div>

    <div class="toggle-group" style="margin-top:8px;">
      <label class="small-label">
        <input type="checkbox" id="sleepToggle" />
        Sleep mode enabled (S1/S0)
      </label>
    </div>

    <div class="battery-display" id="batteryDisplay">
      Battery: -- % ( -- V )
    </div>

    <!-- NEW: current list + pattern circular readout -->
    <div class="current-pattern">
      <div id="currentPatternCircle" class="current-circle">0</div>
      <div id="currentPatternText" class="current-pattern-text">
        Current: List 0 • Pattern 0
      </div>
    </div>
  </div>

  <div class="card">
    <div class="slider-label" style="margin-bottom:4px;">IMU Acceleration (X, Y, Z)</div>
    <canvas id="imuChart" height="160"></canvas>
  </div>

  <div class="card">
    <div class="slider-label" style="margin-bottom:4px;">Mic Level</div>
    <canvas id="micChart" height="120"></canvas>
  </div>

  <script>
    // BLE / UART setup
    const NUS_SERVICE_UUID  = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
    const NUS_RX_CHAR_UUID  = '6e400002-b5a3-f393-e0a9-e50e24dcca9e'; // write
    const NUS_TX_CHAR_UUID  = '6e400003-b5a3-f393-e0a9-e50e24dcca9e'; // notify

    let device, server, uartService, txChar, rxChar;
    let connected = false;
    const enc = new TextEncoder();
    const dec = new TextDecoder();

    const connectBtn   = document.getElementById('connectBtn');
    const statusSpan   = document.getElementById('status');
    const onBtn        = document.getElementById('onBtn');
    const offBtn       = document.getElementById('offBtn');
    const discoOnBtn   = document.getElementById('discoOnBtn');
    const discoOffBtn  = document.getElementById('discoOffBtn');
    const favBtn       = document.getElementById('favBtn');

    const bSlider      = document.getElementById('bSlider');
    const bVal         = document.getElementById('bVal');
    const tSlider      = document.getElementById('tSlider');
    const tVal         = document.getElementById('tVal');
    const iSlider      = document.getElementById('iSlider');
    const iVal         = document.getElementById('iVal');
    const sleepToggle  = document.getElementById('sleepToggle');
    const batteryDisplay = document.getElementById('batteryDisplay');
    const listCircles  = document.getElementById('listCircles');

    const currentPatternCircle = document.getElementById('currentPatternCircle');
    const currentPatternText   = document.getElementById('currentPatternText');

    let inputBuffer = '';

    // Track current list & pattern
    let currentListIndex = 0;
    let currentPatternIndex = 0;

    // Colors for list indices 0..7 (solid fills)
    const listFillColors = [
      '#f9fafb', // 0 white
      '#ef4444', // 1 red
      '#fb923c', // 2 orange
      '#eab308', // 3 yellow
      '#22c55e', // 4 green
      '#3b82f6', // 5 blue
      '#6366f1', // 6 indigo
      '#a855f7', // 7 violet
    ];

    function updateCurrentPatternDisplay(listIdx, patternIdx) {
      // Clamp
      if (listIdx < 0) listIdx = 0;
      if (listIdx > 7) listIdx = 7;
      if (patternIdx < 0) patternIdx = 0;
      if (patternIdx > 100) patternIdx = 100;

      currentListIndex = listIdx;
      currentPatternIndex = patternIdx;

      // Circle fill color
      currentPatternCircle.style.backgroundColor = listFillColors[listIdx] || '#f9fafb';
      currentPatternCircle.textContent = patternIdx;

      currentPatternText.textContent = `Current: List ${listIdx} • Pattern ${patternIdx}`;

      // Update UI controls to match (without fighting user too hard)
      iSlider.value = patternIdx;
      iVal.textContent = patternIdx;

      // Highlight selected list circle
      Array.from(listCircles.querySelectorAll('.list-circle')).forEach(el => {
        el.classList.toggle(
          'selected',
          parseInt(el.dataset.list, 10) === listIdx
        );
      });
    }

    // Initialize readout
    updateCurrentPatternDisplay(0, 0);

    function setUiConnected(isConnected) {
      connected = isConnected;
      connectBtn.textContent = isConnected ? 'Disconnect' : 'Connect';
      statusSpan.textContent = isConnected ? 'Connected to FiddleStIXV1' : 'Not connected';

      onBtn.disabled       = !isConnected;
      offBtn.disabled      = !isConnected;
      discoOnBtn.disabled  = !isConnected;
      discoOffBtn.disabled = !isConnected;
      favBtn.disabled      = !isConnected;
      bSlider.disabled     = !isConnected;
      tSlider.disabled     = !isConnected;
      iSlider.disabled     = !isConnected;
      sleepToggle.disabled = !isConnected;
      Array.from(listCircles.querySelectorAll('.list-circle')).forEach(el => {
        el.style.pointerEvents = isConnected ? 'auto' : 'none';
        el.style.opacity = isConnected ? '1' : '0.5';
      });
    }

    async function connect() {
      try {
        device = await navigator.bluetooth.requestDevice({
          filters: [{ namePrefix: 'FiddleStIXV1' }],
          optionalServices: [NUS_SERVICE_UUID]
        });

        statusSpan.textContent = 'Connecting...';
        server = await device.gatt.connect();
        uartService = await server.getPrimaryService(NUS_SERVICE_UUID);

        rxChar = await uartService.getCharacteristic(NUS_RX_CHAR_UUID);
        txChar = await uartService.getCharacteristic(NUS_TX_CHAR_UUID);

        await txChar.startNotifications();
        txChar.addEventListener('characteristicvaluechanged', onUartNotify);

        device.addEventListener('gattserverdisconnected', () => {
          setUiConnected(false);
        });

        setUiConnected(true);
      } catch (err) {
        console.error(err);
        statusSpan.textContent = 'Error: ' + err;
      }
    }

    async function disconnect() {
      if (device && device.gatt.connected) {
        await device.gatt.disconnect();
      }
      setUiConnected(false);
    }

    async function sendCommand(cmd) {
      if (!connected || !rxChar) return;
      try {
        const data = new TextEncoder().encode(cmd + '\n');
        await rxChar.writeValue(data);
      } catch (err) {
        console.error('sendCommand error', err);
      }
    }

    function onUartNotify(event) {
      const value = event.target.value;
      const text = new TextDecoder().decode(value);
      inputBuffer += text;

      let nlIndex;
      while ((nlIndex = inputBuffer.indexOf('\n')) !== -1) {
        const line = inputBuffer.slice(0, nlIndex).trim();
        inputBuffer = inputBuffer.slice(nlIndex + 1);
        if (line.length > 0) {
          handleTelemetryLine(line);
        }
      }
    }

    // ------------------------------------------------------------------------
    // Telemetry parsing & charts
    // ------------------------------------------------------------------------
    const imuCtx = document.getElementById('imuChart').getContext('2d');
    const micCtx = document.getElementById('micChart').getContext('2d');

    const maxPoints = 150;
    const imuData = {
      labels: [],
      x: [],
      y: [],
      z: [],
    };
    const micData = {
      labels: [],
      level: [],
    };

    const imuChart = new Chart(imuCtx, {
      type: 'line',
      data: {
        labels: imuData.labels,
        datasets: [
          {
            label: 'Ax',
            data: imuData.x,
            borderWidth: 1,
            tension: 0.2,
          },
          {
            label: 'Ay',
            data: imuData.y,
            borderWidth: 1,
            tension: 0.2,
          },
          {
            label: 'Az',
            data: imuData.z,
            borderWidth: 1,
            tension: 0.2,
          },
        ]
      },
      options: {
        animation: false,
        responsive: true,
        scales: {
          x: { display: false },
          y: { title: { display: true, text: 'g' } }
        },
        plugins: {
          legend: { labels: { color: '#e5e7eb' } }
        }
      }
    });

    const micChart = new Chart(micCtx, {
      type: 'line',
      data: {
        labels: micData.labels,
        datasets: [
          {
            label: 'Mic Level',
            data: micData.level,
            borderWidth: 1,
            tension: 0.2,
          }
        ]
      },
      options: {
        animation: false,
        responsive: true,
        scales: {
          x: { display: false },
          y: { title: { display: true, text: 'Level (0–1)' } }
        },
        plugins: {
          legend: { labels: { color: '#e5e7eb' } }
        }
      }
    });

    function addImuSample(ax, ay, az) {
      imuData.labels.push('');
      imuData.x.push(ax);
      imuData.y.push(ay);
      imuData.z.push(az);
      if (imuData.labels.length > maxPoints) {
        imuData.labels.shift();
        imuData.x.shift();
        imuData.y.shift();
        imuData.z.shift();
      }
      imuChart.update('none');
    }

    function addMicSample(level) {
      micData.labels.push('');
      micData.level.push(level);
      if (micData.labels.length > maxPoints) {
        micData.labels.shift();
        micData.level.shift();
      }
      micChart.update('none');
    }

    function handleTelemetryLine(line) {
      const parts = line.split(',');
      if (parts[0] === 'IMU' && parts.length >= 5) {
        const ax = parseFloat(parts[1]);
        const ay = parseFloat(parts[2]);
        const az = parseFloat(parts[3]);
        addImuSample(ax, ay, az);
      } else if (parts[0] === 'MIC' && parts.length >= 2) {
        const level = parseFloat(parts[1]);
        addMicSample(level);
      } else if (parts[0] === 'BAT' && parts.length >= 3) {
        const pct = parseInt(parts[1], 10);
        const volt = parseFloat(parts[2]);
        batteryDisplay.textContent = `Battery: ${pct} % ( ${volt.toFixed(2)} V )`;
      } else if (parts[0] === 'PAT' && parts.length >= 3) {
        const listIdx = parseInt(parts[1], 10);
        const patIdx  = parseInt(parts[2], 10);
        updateCurrentPatternDisplay(listIdx, patIdx);
      }
    }

    // ------------------------------------------------------------------------
    // UI events
    // ------------------------------------------------------------------------
    connectBtn.addEventListener('click', () => {
      if (!connected) connect();
      else disconnect();
    });

    onBtn.addEventListener('click', () => sendCommand('ON'));
    offBtn.addEventListener('click', () => sendCommand('OFF'));
    discoOnBtn.addEventListener('click', () => sendCommand('D1'));
    discoOffBtn.addEventListener('click', () => sendCommand('D0'));
    favBtn.addEventListener('click', () => sendCommand('F'));

    bSlider.addEventListener('input', () => {
      const val = parseInt(bSlider.value, 10);
      bVal.textContent = val;
      if (connected) sendCommand('B' + val);
    });

    tSlider.addEventListener('input', () => {
      const val = parseInt(tSlider.value, 10);
      tVal.textContent = val;
      if (connected) sendCommand('T' + val);
    });

    iSlider.addEventListener('input', () => {
      const val = parseInt(iSlider.value, 10);
      iVal.textContent = val;
      if (connected) {
        sendCommand('I' + val);
        updateCurrentPatternDisplay(currentListIndex, val);
      }
    });

    sleepToggle.addEventListener('change', () => {
      if (!connected) return;
      sendCommand(sleepToggle.checked ? 'S1' : 'S0');
    });

    listCircles.addEventListener('click', (e) => {
      const tgt = e.target.closest('.list-circle');
      if (!tgt || !connected) return;
      const idx = parseInt(tgt.dataset.list, 10);
      sendCommand('L' + idx);
      updateCurrentPatternDisplay(idx, currentPatternIndex);
    });
  </script>
</body>
</html>
