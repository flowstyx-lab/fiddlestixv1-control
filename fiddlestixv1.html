<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>FiddleStIX V1 Controller</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Chart.js from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      background: #111;
      color: #eee;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      padding: 16px;
    }
    h1 {
      margin-top: 0;
      font-size: 1.6rem;
    }
    button {
      margin: 4px;
      padding: 8px 12px;
      border-radius: 6px;
      border: none;
      background: #2c7be5;
      color: white;
      font-weight: 500;
      cursor: pointer;
    }
    button:disabled {
      background: #444;
      cursor: not-allowed;
    }
    .section {
      margin-bottom: 18px;
      padding: 10px;
      border-radius: 8px;
      background: #1b1b1b;
    }
    .controls-row {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }
    .slider-row {
      display: flex;
      flex-direction: column;
      margin: 6px 0;
    }
    input[type="range"] {
      width: 100%;
    }
    label {
      font-size: 0.9rem;
    }
    .bools {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 6px;
    }
    canvas {
      background: #000;
      border-radius: 4px;
      margin-top: 8px;
    }
    .status {
      font-size: 0.85rem;
      color: #ccc;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <h1>FiddleStIX V1 – Web Bluetooth Controller</h1>

  <div class="section">
    <button id="connectBtn">Connect</button>
    <span id="status" class="status">Not connected</span>
  </div>

  <div class="section">
    <h2>Playback Controls</h2>
    <div class="controls-row">
      <button id="prevPageBtn" disabled>Previous Page</button>
      <button id="nextPageBtn" disabled>Next Page</button>
      <button id="prevPatternBtn" disabled>Previous Pattern</button>
      <button id="nextPatternBtn" disabled>Next Pattern</button>
      <button id="favBtn" disabled>Favorite</button>
      <button id="sleepBtn" disabled>Go To Sleep</button>
      <button id="raveBtn" disabled>Rave O’Clock</button>
    </div>
  </div>

  <div class="section">
    <h2>Settings</h2>
    <div class="slider-row">
      <label for="brightnessSlider">
        Global Brightness (0–7, maps to 10–100%): <span id="brightnessLabel">3</span>
      </label>
      <input type="range" id="brightnessSlider" min="0" max="7" value="3">
    </div>
    <div class="slider-row">
      <label for="shuffleSlider">
        Shuffle dwell time (seconds, 1–60): <span id="shuffleLabel">5</span>
      </label>
      <input type="range" id="shuffleSlider" min="1" max="60" value="5">
    </div>
    <div class="bools">
      <label><input type="checkbox" id="shufflePChk"> shuffle_P</label>
      <label><input type="checkbox" id="sleepTimerChk" checked> sleepTimer</label>
      <label><input type="checkbox" id="powerLockChk"> powerLock</label>
    </div>
  </div>

  <div class="section">
    <h2>IMU & Mic Telemetry</h2>
    <p class="status">Live graphs of accelerometer, gyroscope, and mic-level data coming from the device.</p>
    <div>
      <h3>Gyro (deg/s)</h3>
      <canvas id="gyroChart" height="140"></canvas>
    </div>
    <div>
      <h3>Accel (g or m/s²)</h3>
      <canvas id="accelChart" height="140"></canvas>
    </div>
    <div>
      <h3>Mic Level</h3>
      <canvas id="micChart" height="120"></canvas>
    </div>
  </div>

  <script>
    // Nordic UART Service UUIDs (Bluefruit / Adafruit / nRF52)
    // These are standard for BLE UART over NUS.
    const NUS_SERVICE_UUID       = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
    const NUS_CHAR_RX_UUID       = '6e400002-b5a3-f393-e0a9-e50e24dcca9e'; // from browser to device
    const NUS_CHAR_TX_UUID       = '6e400003-b5a3-f393-e0a9-e50e24dcca9e'; // from device to browser

    let bleDevice = null;
    let nusService = null;
    let rxCharacteristic = null;
    let txCharacteristic = null;

    let isConnected = false;

    const connectBtn      = document.getElementById('connectBtn');
    const statusSpan      = document.getElementById('status');
    const prevPageBtn     = document.getElementById('prevPageBtn');
    const nextPageBtn     = document.getElementById('nextPageBtn');
    const prevPatternBtn  = document.getElementById('prevPatternBtn');
    const nextPatternBtn  = document.getElementById('nextPatternBtn');
    const favBtn          = document.getElementById('favBtn');
    const sleepBtn        = document.getElementById('sleepBtn');
    const raveBtn         = document.getElementById('raveBtn');

    const brightnessSlider = document.getElementById('brightnessSlider');
    const brightnessLabel  = document.getElementById('brightnessLabel');
    const shuffleSlider    = document.getElementById('shuffleSlider');
    const shuffleLabel     = document.getElementById('shuffleLabel');

    const shufflePChk    = document.getElementById('shufflePChk');
    const sleepTimerChk  = document.getElementById('sleepTimerChk');
    const powerLockChk   = document.getElementById('powerLockChk');

    function setUiConnected(connected) {
      isConnected = connected;
      connectBtn.textContent = connected ? 'Disconnect' : 'Connect';
      prevPageBtn.disabled    = !connected;
      nextPageBtn.disabled    = !connected;
      prevPatternBtn.disabled = !connected;
      nextPatternBtn.disabled = !connected;
      favBtn.disabled         = !connected;
      sleepBtn.disabled       = !connected;
      raveBtn.disabled        = !connected;
      brightnessSlider.disabled = !connected;
      shuffleSlider.disabled    = !connected;
      shufflePChk.disabled      = !connected;
      sleepTimerChk.disabled    = !connected;
      powerLockChk.disabled     = !connected;
      statusSpan.textContent = connected ? 'Connected' : 'Not connected';
    }

    async function connect() {
      try {
        statusSpan.textContent = 'Requesting device...';
        bleDevice = await navigator.bluetooth.requestDevice({
          filters: [{ services: [NUS_SERVICE_UUID] }]
        });

        statusSpan.textContent = 'Connecting...';
        bleDevice.addEventListener('gattserverdisconnected', onDisconnected);

        const server = await bleDevice.gatt.connect();
        nusService = await server.getPrimaryService(NUS_SERVICE_UUID);

        rxCharacteristic = await nusService.getCharacteristic(NUS_CHAR_RX_UUID);
        txCharacteristic = await nusService.getCharacteristic(NUS_CHAR_TX_UUID);

        await txCharacteristic.startNotifications();
        txCharacteristic.addEventListener('characteristicvaluechanged', onTxNotification);

        setUiConnected(true);
      } catch (error) {
        console.error(error);
        statusSpan.textContent = 'Connection failed: ' + error;
        setUiConnected(false);
      }
    }

    async function disconnect() {
      if (bleDevice && bleDevice.gatt.connected) {
        await bleDevice.gatt.disconnect();
      }
      setUiConnected(false);
    }

    function onDisconnected() {
      setUiConnected(false);
      statusSpan.textContent = 'Disconnected';
    }

    function sendLine(text) {
      if (!isConnected || !rxCharacteristic) return;
      const encoder = new TextEncoder();
      const data = encoder.encode(text + '\n');
      rxCharacteristic.writeValue(data).catch(console.error);
    }

    // -----------------------------
    // Button bindings
    // -----------------------------
    connectBtn.addEventListener('click', () => {
      if (isConnected) {
        disconnect();
      } else {
        connect();
      }
    });

    prevPageBtn.addEventListener('click', () => sendLine('PL'));
    nextPageBtn.addEventListener('click', () => sendLine('NL'));
    prevPatternBtn.addEventListener('click', () => sendLine('PP'));
    nextPatternBtn.addEventListener('click', () => sendLine('NP'));
    favBtn.addEventListener('click', () => sendLine('FAV'));
    sleepBtn.addEventListener('click', () => sendLine('SLEEP'));
    raveBtn.addEventListener('click', () => sendLine('RAVE'));

    brightnessSlider.addEventListener('input', () => {
      brightnessLabel.textContent = brightnessSlider.value;
      sendLine('GB:' + brightnessSlider.value);
    });

    shuffleSlider.addEventListener('input', () => {
      shuffleLabel.textContent = shuffleSlider.value;
      sendLine('T:' + shuffleSlider.value);
    });

    function sendFlags() {
      const flagStr = `FLAGS:shuffle_P=${shufflePChk.checked ? 1 : 0},sleepTimer=${sleepTimerChk.checked ? 1 : 0},powerLock=${powerLockChk.checked ? 1 : 0}`;
      sendLine(flagStr);
    }

    shufflePChk.addEventListener('change', sendFlags);
    sleepTimerChk.addEventListener('change', sendFlags);
    powerLockChk.addEventListener('change', sendFlags);

    // -----------------------------
    // Charts setup
    // -----------------------------

    const maxPoints = 80;
    const labels = Array.from({ length: maxPoints }, (_, i) => '');

    const gyroCtx  = document.getElementById('gyroChart').getContext('2d');
    const accelCtx = document.getElementById('accelChart').getContext('2d');
    const micCtx   = document.getElementById('micChart').getContext('2d');

    const gyroData = {
      labels,
      datasets: [
        { label: 'gx', data: Array(maxPoints).fill(0), borderWidth: 1, tension: 0.2 },
        { label: 'gy', data: Array(maxPoints).fill(0), borderWidth: 1, tension: 0.2 },
        { label: 'gz', data: Array(maxPoints).fill(0), borderWidth: 1, tension: 0.2 }
      ]
    };

    const accelData = {
      labels,
      datasets: [
        { label: 'ax', data: Array(maxPoints).fill(0), borderWidth: 1, tension: 0.2 },
        { label: 'ay', data: Array(maxPoints).fill(0), borderWidth: 1, tension: 0.2 },
        { label: 'az', data: Array(maxPoints).fill(0), borderWidth: 1, tension: 0.2 }
      ]
    };

    const micData = {
      labels,
      datasets: [
        { label: 'mic', data: Array(maxPoints).fill(0), borderWidth: 1, tension: 0.2 }
      ]
    };

    const commonOptions = {
      responsive: true,
      animation: false,
      plugins: { legend: { labels: { color: '#ccc' } } },
      scales: {
        x: { ticks: { color: '#888' }, grid: { color: 'rgba(255,255,255,0.05)' } },
        y: { ticks: { color: '#888' }, grid: { color: 'rgba(255,255,255,0.05)' } }
      }
    };

    const gyroChart = new Chart(gyroCtx, {
      type: 'line',
      data: gyroData,
      options: {
        ...commonOptions,
        scales: { 
          ...commonOptions.scales,
          y: { ...commonOptions.scales.y, suggestedMin: -500, suggestedMax: 500 }
        }
      }
    });

    const accelChart = new Chart(accelCtx, {
      type: 'line',
      data: accelData,
      options: {
        ...commonOptions,
        scales: { 
          ...commonOptions.scales,
          y: { ...commonOptions.scales.y, suggestedMin: -4, suggestedMax: 4 }
        }
      }
    });

    const micChart = new Chart(micCtx, {
      type: 'line',
      data: micData,
      options: {
        ...commonOptions,
        scales: { 
          ...commonOptions.scales,
          y: { ...commonOptions.scales.y, suggestedMin: 0, suggestedMax: 1 }
        }
      }
    });

    function pushData(dataset, v) {
      dataset.data.push(v);
      if (dataset.data.length > maxPoints) dataset.data.shift();
    }

    function onTxNotification(event) {
      const value = event.target.value;
      const decoder = new TextDecoder('utf-8');
      const text = decoder.decode(value);
      const lines = text.split(/\r?\n/);

      for (const line of lines) {
        if (!line.trim()) continue;
        if (line.startsWith('IMU:')) {
          const rest = line.slice(4);
          const parts = rest.split(',');
          if (parts.length === 6) {
            const ax = parseFloat(parts[0]);
            const ay = parseFloat(parts[1]);
            const az = parseFloat(parts[2]);
            const gx = parseFloat(parts[3]);
            const gy = parseFloat(parts[4]);
            const gz = parseFloat(parts[5]);

            pushData(accelData.datasets[0], ax);
            pushData(accelData.datasets[1], ay);
            pushData(accelData.datasets[2], az);
            accelChart.update('none');

            pushData(gyroData.datasets[0], gx);
            pushData(gyroData.datasets[1], gy);
            pushData(gyroData.datasets[2], gz);
            gyroChart.update('none');
          }
        } else if (line.startsWith('MIC:')) {
          const rest = line.slice(4);
          const val = parseFloat(rest);
          pushData(micData.datasets[0], val);
          micChart.update('none');
        }
      }
    }

    // Initial UI state
    setUiConnected(false);
  </script>
</body>
</html>
